# Spring Securityì—ì„œ `OAuth2User` / `OidcUser`  ğŸ”ğŸ”

(= â€œë¡œê·¸ì¸ í›„ SecurityContext ì•ˆì—ëŠ” ë¬´ì—‡ì´ ë“¤ì–´ìˆë‚˜?â€)

OAuth2 ë¡œê·¸ì¸(OAuth2Login)ì„ êµ¬ì„±í•˜ë©´, ì¸ì¦ì´ ëë‚œ ë’¤ Spring Security ë‚´ë¶€ì—ëŠ” **ì‚¬ìš©ì ì •ë³´ ê°ì²´(Principal)** ê°€ ì €ì¥ë©ë‹ˆë‹¤.
ê·¸ í•µì‹¬ ì¸í„°í˜ì´ìŠ¤ê°€ ë°”ë¡œ:

* `OAuth2User`
* `OidcUser`

ì…ë‹ˆë‹¤.

ì´ ë‘˜ì˜ **ìƒì† êµ¬ì¡°, ë‚´ë¶€ êµ¬ì„±ìš”ì†Œ, ì‹¤ì œ ì €ì¥ êµ¬ì¡°, ì‹¤í–‰ íë¦„ê¹Œì§€** ì •ë¦¬í•´ë³´ê² ìŠµë‹ˆë‹¤. ğŸ§ âœ¨

---

# 1ï¸âƒ£ ì „ì²´ ì•„í‚¤í…ì²˜ íë¦„ ë³µìŠµ ğŸ§­

OAuth2 ë¡œê·¸ì¸ íë¦„ (Authorization Code ê¸°ì¤€):

```
[1] /oauth2/authorization/google
[2] â†’ OAuth2AuthorizationRequestRedirectFilter
[3] â†’ ë¡œê·¸ì¸ í›„ /login/oauth2/code/google
[4] â†’ OAuth2LoginAuthenticationFilter
        â”œâ”€ Access Token êµí™˜
        â”œâ”€ (OIDCë©´) ID Token ê²€ì¦
        â””â”€ UserInfo Endpoint í˜¸ì¶œ
[5] â†’ OAuth2User / OidcUser ìƒì„±
[6] â†’ OAuth2AuthenticationToken ìƒì„±
[7] â†’ SecurityContextHolder ì €ì¥
```

ğŸ‘‰ ì—¬ê¸°ì„œ 5ë²ˆì´ ì˜¤ëŠ˜ì˜ í•µì‹¬ì…ë‹ˆë‹¤.

---

# 2ï¸âƒ£ `OAuth2User` ì¸í„°í˜ì´ìŠ¤ êµ¬ì¡° ğŸ§©

`OAuth2User`ëŠ” ì•„ì£¼ ë‹¨ìˆœí•©ë‹ˆë‹¤.

```java
public interface OAuth2User extends OAuth2AuthenticatedPrincipal {
    Map<String, Object> getAttributes();
}
```

ê·¸ë¦¬ê³  ìƒìœ„ ì¸í„°í˜ì´ìŠ¤:

```java
public interface OAuth2AuthenticatedPrincipal extends AuthenticatedPrincipal {
    Collection<? extends GrantedAuthority> getAuthorities();
    Map<String, Object> getAttributes();
}
```

ğŸ“Œ í•µì‹¬ êµ¬ì„±ìš”ì†Œ:

| êµ¬ì„±ìš”ì†Œ          | ì˜ë¯¸                       |
| ------------- | ------------------------ |
| `attributes`  | UserInfo ì‘ë‹µ JSON Map     |
| `authorities` | ê¶Œí•œ ëª©ë¡                    |
| `name`        | Principal ì´ë¦„ (getName()) |

---

## ì‹¤ì œ êµ¬í˜„ í´ë˜ìŠ¤: `DefaultOAuth2User` ğŸ—ï¸

OAuth2 ë¡œê·¸ì¸(OIDC ì•„ë‹˜)ì—ì„œëŠ” ë³´í†µ ì´ê²ƒì´ ì‚¬ìš©ë©ë‹ˆë‹¤.

```java
public class DefaultOAuth2User implements OAuth2User {
    private final Collection<? extends GrantedAuthority> authorities;
    private final Map<String, Object> attributes;
    private final String nameAttributeKey;
}
```

### ğŸ” ë‚´ë¶€ í•„ë“œ ì„¤ëª…

### 1ï¸âƒ£ authorities

* ROLE_USER ë“±
* Scope ê¸°ë°˜ ê¶Œí•œ
* OAuth2UserAuthority í¬í•¨ ê°€ëŠ¥

### 2ï¸âƒ£ attributes

* UserInfo Endpoint ì‘ë‹µ ê·¸ëŒ€ë¡œ Map
* ì˜ˆ:

```json
{
  "id": 12345,
  "login": "kim",
  "email": "kim@example.com"
}
```

### 3ï¸âƒ£ nameAttributeKey â­

* `getName()` í˜¸ì¶œ ì‹œ ì–´ë–¤ í‚¤ë¥¼ ì“¸ì§€ ê²°ì •
* ì˜ˆ:

  * google â†’ `"sub"`
  * github â†’ `"id"`
  * naver â†’ `"response.id"`

ğŸ‘‰ ì´ê²Œ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤.
Springì´ â€œì´ ì‚¬ìš©ìì˜ ëŒ€í‘œ ì‹ë³„ê°’â€ì„ ë¬´ì—‡ìœ¼ë¡œ ë³¼ì§€ ê²°ì •í•©ë‹ˆë‹¤.

---

# 3ï¸âƒ£ `OidcUser` êµ¬ì¡° (OIDC ë¡œê·¸ì¸ì¼ ë•Œ) ğŸªªâœ¨

`OidcUser`ëŠ” `OAuth2User`ë¥¼ í™•ì¥í•©ë‹ˆë‹¤.

```java
public interface OidcUser extends OAuth2User {
    OidcIdToken getIdToken();
    OidcUserInfo getUserInfo();
}
```

ì¦‰:

```
OidcUser
   â””â”€â”€ OAuth2User
         â””â”€â”€ OAuth2AuthenticatedPrincipal
```

---

## ì‹¤ì œ êµ¬í˜„ í´ë˜ìŠ¤: `DefaultOidcUser`

```java
public class DefaultOidcUser implements OidcUser {

    private final OidcIdToken idToken;
    private final OidcUserInfo userInfo;
    private final Collection<? extends GrantedAuthority> authorities;
}
```

---

# 4ï¸âƒ£ OidcUser ë‚´ë¶€ êµ¬ì„±ìš”ì†Œ ìƒì„¸ ë¶„ì„ ğŸ”¬

## 1ï¸âƒ£ OidcIdToken ğŸªª

JWT ê¸°ë°˜ ê°ì²´ì…ë‹ˆë‹¤.

```java
public class OidcIdToken extends AbstractOAuth2Token {
    private final Map<String, Object> claims;
}
```

ì—¬ê¸°ì—ëŠ”:

| Claim | ì„¤ëª…        |
| ----- | --------- |
| iss   | issuer    |
| sub   | ì‚¬ìš©ì ì‹ë³„ì â­ |
| aud   | client id |
| exp   | ë§Œë£Œì‹œê°„      |
| email | ì´ë©”ì¼       |
| name  | ì´ë¦„        |

ğŸ‘‰ ID Token ê²€ì¦ì€ **JwtDecoder**ê°€ ì²˜ë¦¬í•©ë‹ˆë‹¤.

---

## 2ï¸âƒ£ OidcUserInfo ğŸ‘¤

UserInfo Endpoint ì‘ë‹µ ë˜í¼ì…ë‹ˆë‹¤.

```java
public class OidcUserInfo {
    private final Map<String, Object> claims;
}
```

ğŸ“Œ íŠ¹ì§•

* ID Tokenê³¼ ë‹¤ë¥´ê²Œ Access Tokenìœ¼ë¡œ ì¡°íšŒ
* ë” í’ë¶€í•œ í”„ë¡œí•„ ê°€ëŠ¥

---

# 5ï¸âƒ£ OAuth2User vs OidcUser ì°¨ì´ ì •ë¦¬ ğŸ“Š

| êµ¬ë¶„           | OAuth2User | OidcUser       |
| ------------ | ---------- | -------------- |
| ê¸°ë°˜           | OAuth2     | OpenID Connect |
| ID Token     | âŒ ì—†ìŒ       | âœ… ìˆìŒ           |
| UserInfo     | ë³´í†µ ìˆìŒ      | ìˆìŒ             |
| getClaims()  | âŒ          | âœ…              |
| getIdToken() | âŒ          | âœ…              |

ğŸ‘‰ OIDCëŠ” ì¸ì¦(Authentication) ê°œë…ì´ í¬í•¨ë˜ë¯€ë¡œ ID Tokenì´ ì¡´ì¬í•©ë‹ˆë‹¤.

---

# 6ï¸âƒ£ ì‹¤ì œ SecurityContext ì•ˆ êµ¬ì¡° ğŸ—„ï¸

ë¡œê·¸ì¸ ì„±ê³µ í›„:

```
SecurityContext
  â””â”€â”€ Authentication (OAuth2AuthenticationToken)
        â”œâ”€â”€ principal (OAuth2User or OidcUser)
        â”œâ”€â”€ authorities
        â””â”€â”€ clientRegistrationId
```

`OAuth2AuthenticationToken` ë‚´ë¶€:

```java
public class OAuth2AuthenticationToken extends AbstractAuthenticationToken {
    private final OAuth2User principal;
    private final String authorizedClientRegistrationId;
}
```

ğŸ“Œ ì¦‰:

* principal = DefaultOAuth2User or DefaultOidcUser
* authorities = GrantedAuthority ëª©ë¡

---

# 7ï¸âƒ£ ì‹¤ì œ ë©”ëª¨ë¦¬ êµ¬ì¡° ê·¸ë¦¼ ğŸ§ 

```
SecurityContextHolder
   â””â”€â”€ SecurityContext
         â””â”€â”€ OAuth2AuthenticationToken
               â”œâ”€â”€ principal (DefaultOidcUser)
               â”‚       â”œâ”€â”€ idToken
               â”‚       â”‚      â””â”€â”€ claims
               â”‚       â”œâ”€â”€ userInfo
               â”‚       â”‚      â””â”€â”€ claims
               â”‚       â””â”€â”€ authorities
               â””â”€â”€ clientRegistrationId
```

---

# 8ï¸âƒ£ getAttributes()ëŠ” ì–´ë””ì—ì„œ ì˜¤ë‚˜? ğŸ¤”

### OAuth2Userì¼ ê²½ìš°

â†’ UserInfo Endpoint JSON ê·¸ëŒ€ë¡œ

### OidcUserì¼ ê²½ìš°

â†’ ê¸°ë³¸ì ìœ¼ë¡œ:

```
ID Token claims + UserInfo claims ë³‘í•©
```

ğŸ‘‰ ì¶©ëŒ ì‹œ UserInfo ìš°ì„ 

---

# 9ï¸âƒ£ name()ì€ ì–´ë–»ê²Œ ê²°ì •ë˜ë‚˜? ğŸ”‘

`getName()`ì€:

```java
attributes.get(nameAttributeKey).toString()
```

OIDCì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ `sub` ì‚¬ìš©

ğŸ‘‰ ê·¸ë˜ì„œ ì‹¤ë¬´ì—ì„œëŠ”:

```
(provider, sub)
```

ì¡°í•©ì„ ë‚´ë¶€ PKë¡œ ë§ì´ ì‚¬ìš©í•©ë‹ˆë‹¤.

---

# ğŸ”Ÿ Authority êµ¬ì„± ì›ë¦¬ ğŸ›¡ï¸

Springì€ ë‹¤ìŒì„ ê¶Œí•œìœ¼ë¡œ ë³€í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* `SCOPE_profile`
* `SCOPE_email`
* ì»¤ìŠ¤í…€ Role ë§¤í•‘

ì˜ˆ:

```java
GrantedAuthority authority =
   new OAuth2UserAuthority(attributes);
```

---

# 1ï¸âƒ£1ï¸âƒ£ ì‹¤ë¬´ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ì„¤ê³„ í¬ì¸íŠ¸ ğŸš§

## âœ… 1. attributesëŠ” ì ˆëŒ€ ê·¸ëŒ€ë¡œ ì“°ì§€ ë§ˆì„¸ìš”

Providerë§ˆë‹¤ í‚¤ ë‹¤ë¦„

## âœ… 2. í•­ìƒ DTOë¡œ ì •ê·œí™”í•˜ì„¸ìš”

```
UserProfile {
  provider,
  providerUserId (sub),
  email,
  name,
  picture
}
```

## âœ… 3. subëŠ” ë³€í•˜ì§€ ì•ŠëŠ” ì‹ë³„ìì…ë‹ˆë‹¤

emailì€ ë°”ë€” ìˆ˜ ìˆìŒ

## âœ… 4. OIDCë¼ë©´ idToken ê¸°ë°˜ ì¸ì¦ ì‹ ë¢°

UserInfoëŠ” ë³´ì¡°ì  ì •ë³´

---

# 1ï¸âƒ£2ï¸âƒ£ í•œ ì¤„ ìš”ì•½ ğŸ§¾âœ¨

* `OAuth2User` = UserInfo JSON + ê¶Œí•œ
* `OidcUser` = ID Token + UserInfo + ê¶Œí•œ
* ë¡œê·¸ì¸ í›„ SecurityContextì—ëŠ” `OAuth2AuthenticationToken`ì´ ì €ì¥ë¨
* ë‚´ë¶€ì ìœ¼ë¡œ Map ê¸°ë°˜ attributes êµ¬ì¡°
* ì‹¤ë¬´ í•µì‹¬ì€ â€œì •ê·œí™” + sub ê¸°ë°˜ ì‹ë³„â€

---
### ì°¸ê³  ì‚¬í•­
* ğŸ”¥ ID Token ê²€ì¦ íë¦„ (JwtDecoder ë‚´ë¶€)
