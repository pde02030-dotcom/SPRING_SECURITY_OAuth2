# `DefaultAuthorizationCodeTokenResponseClient` ì½”ë“œ ë ˆë²¨ ë¶„ì„ ğŸ”ğŸ«

(= â€œAuthorization Codeë¥¼ **Access Token**ìœ¼ë¡œ ë°”ê¾¸ëŠ” â€˜í† í° êµí™˜ê¸°â€™â€)

Spring Security OAuth2 Loginì—ì„œ **ì¸ê°€ ì½”ë“œ(authorization code)** ë¥¼ ë°›ì€ ë’¤, ë‹¤ìŒ ë‹¨ê³„ëŠ” ë¬´ì¡°ê±´ ì´ê²ƒì…ë‹ˆë‹¤:

âœ… **Authorization Serverì˜ Token Endpoint**ë¡œ ê°€ì„œ
âœ… `code`ë¥¼ ë˜ì§€ê³ 
âœ… `access_token`(ê·¸ë¦¬ê³  OIDCë©´ `id_token`)ì„ ë°›ì•„ì˜¤ëŠ” ê²ƒ ğŸ

ì´ â€œí† í° êµí™˜â€ì„ ë””í´íŠ¸ êµ¬í˜„ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ” í´ë˜ìŠ¤ê°€ ë°”ë¡œ:

> `DefaultAuthorizationCodeTokenResponseClient`

ì…ë‹ˆë‹¤. ğŸ§©

---

## 1) ì´ í´ë˜ìŠ¤ëŠ” ì–¸ì œ í˜¸ì¶œë˜ë‚˜ìš”? ğŸ§­

íë¦„ì„ ë‹¤ì‹œ ë”± ì°ìœ¼ë©´:

```text
/login/oauth2/code/{registrationId}
  â†’ OAuth2LoginAuthenticationFilter
     â†’ OAuth2LoginAuthenticationProvider
        â†’ DefaultAuthorizationCodeTokenResponseClient.getTokenResponse(...)  â­
        â†’ (OIDCë©´) id_token íŒŒì‹±/ê²€ì¦
        â†’ OAuth2UserService / OidcUserService
        â†’ Authentication ì™„ì„±
```

ì¦‰, **OAuth2 ë¡œê·¸ì¸ íŒŒì´í”„ë¼ì¸ì˜ â€œì¤‘ì•™ ë³€í™˜ê¸°â€** ì…ë‹ˆë‹¤. ğŸ¯

---

## 2) íƒ€ì… ì‹œê·¸ë‹ˆì²˜ë¶€í„° ì˜ë¯¸ê°€ ëª…í™•í•©ë‹ˆë‹¤ ğŸ§¾

`DefaultAuthorizationCodeTokenResponseClient`ëŠ” ì•„ë˜ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ì²´ì…ë‹ˆë‹¤:

* `OAuth2AccessTokenResponseClient<OAuth2AuthorizationCodeGrantRequest>`

ì¦‰,

âœ… ì…ë ¥: `OAuth2AuthorizationCodeGrantRequest`
âœ… ì¶œë ¥: `OAuth2AccessTokenResponse` (í† í° ì‘ë‹µ)

---

## 3) ì…ë ¥ ê°ì²´(`OAuth2AuthorizationCodeGrantRequest`) ì•ˆì—ëŠ” ë­ê°€ ìˆë‚˜? ğŸ“¦

í† í° êµí™˜ì— í•„ìš”í•œ ê²ƒë“¤ì´ â€œíŒ¨í‚¤ì§€â€ë¡œ ë“¤ì–´ìˆìŠµë‹ˆë‹¤.

### âœ… í¬í•¨ë˜ëŠ” í•µì‹¬ êµ¬ì„±ìš”ì†Œ

* `ClientRegistration`

  * token-uri, client-id, client-secret, auth method ë“± ì„¤ì •
* `OAuth2AuthorizationExchange`

  * Authorization Request (ìš”ì²­ ë‹¹ì‹œ redirect_uri, state ë“±)
  * Authorization Response (ë¦¬ë‹¤ì´ë ‰íŠ¸ë¡œ ëŒì•„ì˜¨ `code`, `state`)
* (PKCEë©´) code_verifier ë“± ì¶”ê°€ íŒŒë¼ë¯¸í„°

---

## 4) ë‚´ë¶€ ë™ì‘ í•µì‹¬ ì•Œê³ ë¦¬ì¦˜ (ì½”ë“œ ë ˆë²¨) ğŸ§ âš™ï¸

ì•„ë˜ëŠ” **ì‹¤ì œ ë‚´ë¶€ êµ¬ì¡°ë¥¼ â€œí”„ë ˆì„ì›Œí¬ ì½”ë“œ ëŠë‚Œâ€ìœ¼ë¡œ ì¬êµ¬ì„±í•œ ì˜ì‚¬ì½”ë“œ**ì…ë‹ˆë‹¤.

```java
OAuth2AccessTokenResponse getTokenResponse(OAuth2AuthorizationCodeGrantRequest request) {

  // 1) Token ìš”ì²­ì„ HTTP RequestEntityë¡œ ë³€í™˜
  RequestEntity<?> tokenRequest = requestEntityConverter.convert(request);

  // 2) RestOperations(RestTemplate)ë¡œ Token Endpoint í˜¸ì¶œ
  ResponseEntity<Map<String, Object>> response =
      restOperations.exchange(tokenRequest, responseType);

  // 3) ì‘ë‹µ(Map)ì„ OAuth2AccessTokenResponseë¡œ ë³€í™˜
  Map<String, Object> tokenResponseParameters = response.getBody();
  return tokenResponseConverter.convert(tokenResponseParameters);
}
```

ì—¬ê¸°ì„œ â€œì§„ì§œ í•µì‹¬â€ì€ 3ê°œì…ë‹ˆë‹¤. ğŸ”¥

1. **requestEntityConverter** (ìš”ì²­ì„ ì–´ë–»ê²Œ ë§Œë“¤ê¹Œ?)
2. **restOperations** (ì–´ë–»ê²Œ í˜¸ì¶œí• ê¹Œ?)
3. **tokenResponseConverter** (ì‘ë‹µì„ ì–´ë–»ê²Œ íŒŒì‹±í• ê¹Œ?)

---

## 5) 1ë²ˆ í•µì‹¬: Token RequestëŠ” ì–´ë–»ê²Œ ë§Œë“¤ì–´ì§€ë‚˜? ğŸ§¾â¡ï¸ğŸ“¡

í† í° ì—”ë“œí¬ì¸íŠ¸ëŠ” ë³´í†µ `application/x-www-form-urlencoded` í˜•íƒœë¡œ ìš”ì²­í•©ë‹ˆë‹¤.

### âœ… ê¸°ë³¸ form parameter êµ¬ì„±

* `grant_type=authorization_code`
* `code={authorization_code}`
* `redirect_uri={redirect_uri}`  (ë§¤ìš° ì¤‘ìš”)
* `client_id` (ì¸ì¦ ë°©ì‹ì— ë”°ë¼ í¬í•¨ë˜ê¸°ë„/ì•ˆë˜ê¸°ë„)
* (PKCEë©´) `code_verifier`

ì¦‰ ì¼ë°˜ì ìœ¼ë¡œ ì´ëŸ° í¼ì´ ë©ë‹ˆë‹¤:

```text
POST /oauth/token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code
&code=SplxlOBeZQQYbYS6WxSbIA
&redirect_uri=https://client.com/login/oauth2/code/google
&client_id=...
&client_secret=...   (or Authorization header)
```

---

## 6) Client ì¸ì¦ ë°©ì‹ì— ë”°ë¼ ìš”ì²­ì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤ ğŸ”

`ClientRegistration.clientAuthenticationMethod` ê°’ì— ë”°ë¼ í† í° ìš”ì²­ì´ ë°”ë€ë‹ˆë‹¤.

### âœ… (1) `client_secret_basic` (ê°€ì¥ í”í•¨) ğŸ”’

* HTTP Basic Authë¡œ client ì¸ì¦

```http
Authorization: Basic base64(clientId:clientSecret)
```

ğŸ“Œ ì´ ê²½ìš° ë³´í†µ **formì— client_secretì„ ë„£ì§€ ì•ŠìŠµë‹ˆë‹¤.**

---

### âœ… (2) `client_secret_post` ğŸ§¾

* form bodyì— `client_id`, `client_secret`ì„ í•¨ê»˜ ë„£ìŒ

---

### âœ… (3) `none` (PKCE public client) ğŸ§·

* SPA/ëª¨ë°”ì¼ ê°™ì€ public client
* client_secretì´ ì—†ìŒ
* ëŒ€ì‹  PKCEì˜ `code_verifier`ê°€ ì¤‘ìš”í•´ì§

---

## 7) 2ë²ˆ í•µì‹¬: í˜¸ì¶œì€ ëˆ„ê°€ í•˜ë‚˜ìš”? (`RestOperations`) ğŸŒ

ê¸°ë³¸ì ìœ¼ë¡œ ë‚´ë¶€ì— `RestTemplate`(RestOperations)ê°€ ë“¤ì–´ìˆìŠµë‹ˆë‹¤.

* ê¸°ë³¸ message converterë¡œ form ìš”ì²­/JSON ì‘ë‹µì„ ì²˜ë¦¬
* ê¸°ë³¸ error handlerë¡œ ì˜¤ë¥˜ ì‘ë‹µì„ ì˜ˆì™¸ë¡œ ë³€í™˜

ğŸ“Œ ì‹¤ë¬´ í¬ì¸íŠ¸
Authorization Serverê°€ â€œí† í° ì‘ë‹µ í¬ë§·â€ì„ ì•½ê°„ ë‹¤ë¥´ê²Œ ì£¼ê±°ë‚˜,
ì—ëŸ¬ ë°”ë”” êµ¬ì¡°ê°€ ì»¤ìŠ¤í…€ì´ë¼ë©´
ì—¬ê¸°(RestOperations) ì»¤ìŠ¤í„°ë§ˆì´ì§•ì´ ìì£¼ í•„ìš”í•©ë‹ˆë‹¤. ğŸ”§

---

## 8) 3ë²ˆ í•µì‹¬: ì‘ë‹µ íŒŒì‹±ì€ ì–´ë–»ê²Œ í•˜ë‚˜ìš”? ğŸâ¡ï¸ğŸ§±

Token endpoint ì‘ë‹µì€ ë³´í†µ JSON:

```json
{
  "access_token": "xxx",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "yyy",
  "scope": "openid profile email",
  "id_token": "zzz" // OIDCì¼ ë•Œ
}
```

ì´ê±¸ Springì´ `OAuth2AccessTokenResponse`ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

### âœ… `OAuth2AccessTokenResponse` ì•ˆì— ë‹´ê¸°ëŠ” ê²ƒ

* `OAuth2AccessToken` (token value, type, issuedAt, expiresAt, scopes)
* `refresh_token` (ìˆì„ ìˆ˜ ìˆìŒ)
* `additionalParameters` (ì—¬ê¸°ì— `id_token` ê°™ì€ ê²Œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆìŒ) â­

ğŸ“Œ íŠ¹íˆ OIDC ë¡œê·¸ì¸ì—ì„œ `id_token`ì€ ë³´í†µ
`additionalParameters["id_token"]`ì— ë“¤ì–´ì˜µë‹ˆë‹¤. ğŸªª

---

## 9) ì‹¤íŒ¨í•˜ë©´ ì–´ë–¤ ì˜ˆì™¸ê°€ í„°ì§€ë‚˜ìš”? ğŸ’¥

í† í° êµí™˜ì´ ì‹¤íŒ¨í•˜ë©´ ëŒ€í‘œì ìœ¼ë¡œ:

* `OAuth2AuthorizationException`
* `OAuth2AuthenticationException`

ë¥˜ë¡œ ì „í™˜ë˜ì–´ ì˜¬ë¼ì˜µë‹ˆë‹¤.

ì‹¤íŒ¨ ì›ì¸ ì˜ˆ:

* code ë§Œë£Œ/ì¬ì‚¬ìš©
* redirect_uri ë¶ˆì¼ì¹˜ (ì§„ì§œ í”í•¨) ğŸš¨
* client ì¸ì¦ ì‹¤íŒ¨
* PKCE code_verifier ë¶ˆì¼ì¹˜
* token endpointê°€ 400/401 ë°˜í™˜

---

## 10) ì‹¤ë¬´ì—ì„œ ì œì¼ ë§ì´ í„°ì§€ëŠ” í¬ì¸íŠ¸ TOP 5 ğŸš§

### 1ï¸âƒ£ `redirect_uri` ë¶ˆì¼ì¹˜ ğŸš¨

* Authorization Request ë•Œ ì‚¬ìš©í•œ redirect_uriì™€
* Token Requestì— ë„£ëŠ” redirect_uriê°€
* ì„œë²„ ê¸°ì¤€ìœ¼ë¡œ **ì™„ì „íˆ ë™ì¼**í•´ì•¼ í•˜ëŠ” Providerê°€ ë§ìŠµë‹ˆë‹¤.

### 2ï¸âƒ£ client authentication ë°©ì‹ ë¶ˆì¼ì¹˜ ğŸ”

* ì„œë²„ëŠ” basicì„ ê¸°ëŒ€í•˜ëŠ”ë° postë¡œ ë³´ë‚´ë©´ ì‹¤íŒ¨

### 3ï¸âƒ£ PKCE ëˆ„ë½ ğŸ§·

* public clientì¸ë° code_verifier ì•ˆ ë„£ìœ¼ë©´ ì‹¤íŒ¨

### 4ï¸âƒ£ Token endpoint ì‘ë‹µ í¬ë§· ì»¤ìŠ¤í…€ ğŸ­

* í‘œì¤€ í‚¤(`access_token`, `token_type`)ê°€ ë‹¤ë¥´ë©´ íŒŒì‹± ì‹¤íŒ¨

### 5ï¸âƒ£ í”„ë¡ì‹œ/ê²Œì´íŠ¸ì›¨ì´ í™˜ê²½ì—ì„œ redirect_uriê°€ í™˜ê²½ë³„ë¡œ ë‹¬ë¼ì§ ğŸŒ

* ë¡œì»¬/ìŠ¤í…Œì´ì§•/ìš´ì˜ì—ì„œ ë“±ë¡ëœ redirect URIê°€ ë‹¤ë¥´ë©´ ì½”ë“œ êµí™˜ ë‹¨ê³„ì—ì„œ ê¹¨ì§

---

## 11) ì»¤ìŠ¤í„°ë§ˆì´ì§• í¬ì¸íŠ¸ 3ì¢… ì„¸íŠ¸ ğŸ”§ğŸ§©

`DefaultAuthorizationCodeTokenResponseClient`ëŠ” â€œí›…â€ì´ ë¹„êµì  ëª…í™•í•©ë‹ˆë‹¤.

### âœ… 1) ìš”ì²­ ìƒì„±ê¸° êµì²´ (RequestEntityConverter)

* íŠ¹ìˆ˜ í—¤ë” ì¶”ê°€
* íŠ¹ì • íŒŒë¼ë¯¸í„° ì¶”ê°€
* grant_type ë³€í˜•(ê±°ì˜ ì—†ìŒ)
* ë©€í‹°í…Œë„ŒíŠ¸ token endpoint ì„ íƒ ë“±

### âœ… 2) RestOperations êµì²´

* ì»¤ìŠ¤í…€ SSL/TLS
* í”„ë¡ì‹œ
* timeout ì„¤ì •
* ì»¤ìŠ¤í…€ error handler

### âœ… 3) TokenResponseConverter ì»¤ìŠ¤í„°ë§ˆì´ì§•

* ì‘ë‹µ JSON í‚¤ê°€ ì»¤ìŠ¤í…€ì¸ ì„œë²„ ëŒ€ì‘
* ì¶”ê°€ íŒŒë¼ë¯¸í„° ë³€í™˜ ë¡œì§ ê°•í™”

---

## 12) í•œ ì¤„ ìš”ì•½ ğŸ§¾âœ¨

`DefaultAuthorizationCodeTokenResponseClient`ëŠ”

âœ… **Authorization Code Grant**ì—ì„œ
âœ… **Token Endpoint**ë¡œ ìš”ì²­ì„ ë§Œë“¤ì–´ ë³´ë‚´ê³ 
âœ… ì‘ë‹µì„ `OAuth2AccessTokenResponse`ë¡œ íŒŒì‹±í•´ ë°˜í™˜í•˜ëŠ”
**â€œí† í° êµí™˜ì˜ í‘œì¤€ ì—”ì§„â€**ì…ë‹ˆë‹¤. ğŸ«âš™ï¸

---

### ì°¸ê³  ì‚¬í•­
* ğŸ”¥ PKCEê°€ ë¼ì–´ë“¤ ë•Œ `code_verifier`ê°€ ì–´ë””ì„œ ìƒì„±/ì €ì¥/ì „ë‹¬ë˜ëŠ”ì§€
* ğŸ”¥ ì»¤ìŠ¤í…€ Authorization Server(issuer-uri)ì—ì„œ í† í° ì‘ë‹µ ì»¤ìŠ¤í…€í•  ë•Œ ë§ì¶”ëŠ” ë°©ë²•
