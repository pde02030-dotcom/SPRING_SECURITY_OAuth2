# `ClientRegistration`  ğŸ§©ğŸ”

Spring Securityì—ì„œ OAuth2 ë¡œê·¸ì¸ì„ êµ¬ì„±í•  ë•Œ, ì§„ì§œ í•µì‹¬ì€ â€œí•„í„°â€ë³´ë‹¤ë„ **`ClientRegistration`** ì…ë‹ˆë‹¤.
ì™œëƒí•˜ë©´ OAuth2 Loginì˜ ê±°ì˜ ëª¨ë“  ë™ì‘(ì–´ë””ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í• ì§€, í† í°ì„ ì–´ë””ì„œ ë°›ì„ì§€, ìœ ì € ì •ë³´ë¥¼ ì–´ë””ì„œ ê°€ì ¸ì˜¬ì§€, scopeëŠ” ë­”ì§€)ì„ **ì´ ê°ì²´ê°€ ì •ì˜**í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ğŸ¯

---

## 1) `ClientRegistration`ì´ë€ ë¬´ì—‡ì¸ê°€? ğŸ·ï¸

> `ClientRegistration`ì€ **Authorization Server(êµ¬ê¸€/ê¹ƒí—ˆë¸Œ/ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ ë“±)ì— ë“±ë¡ëœ â€œìš°ë¦¬ ì•±(í´ë¼ì´ì–¸íŠ¸)â€ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ ë‹´ì€ ê°ì²´**ì…ë‹ˆë‹¤.

ì¦‰, ë‹¤ìŒì„ í•œ ë©ì–´ë¦¬ë¡œ ë“¤ê³  ìˆëŠ” â€œì„¤ì • ìŠ¤ëƒ…ìƒ·â€ì…ë‹ˆë‹¤.

* client-id / client-secret ğŸ”‘
* authorization-uri / token-uri / userinfo-uri ğŸŒ
* redirect-uri í…œí”Œë¦¿ ğŸ”
* scopes ğŸ«
* client authentication ë°©ì‹(client_secret_basic ë“±) ğŸ›¡ï¸
* providerì˜ ì‚¬ìš©ì ì‹ë³„ í‚¤(user-name-attribute) ğŸ·ï¸
* OIDCë©´ issuer-uri, jwk-set-uri ë“± ğŸªª

---

## 2) `ClientRegistration`ì€ ì–¸ì œ/ì–´ë””ì„œ ì“°ì´ë‚˜? ğŸ”ğŸ§ 

OAuth2 Login íë¦„ì—ì„œ `ClientRegistration`ì€ ê±°ì˜ ì „ êµ¬ê°„ì— ë“±ì¥í•©ë‹ˆë‹¤.

### âœ… ì£¼ìš” ì‚¬ìš© ì§€ì 

1. **ë¡œê·¸ì¸ ì‹œì‘**: Authorization Request ë§Œë“¤ ë•Œ

   * client_id, scope, redirect_uri, authorization_uri ì‚¬ìš© ğŸ§¾
2. **ì½œë°± ì²˜ë¦¬**: code â†’ token êµí™˜í•  ë•Œ

   * token_uri, client auth method, redirect_uri ì‚¬ìš© ğŸ”‘
3. **UserInfo í˜¸ì¶œ**: access tokenìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ì–»ì„ ë•Œ

   * userinfo_uri, user-name-attribute ì‚¬ìš© ğŸ‘¤ğŸ“¡
4. **Principal êµ¬ì„±**: `OAuth2User.getName()` ê²°ì •

   * `userNameAttributeName`ì´ í•µì‹¬ ğŸ·ï¸

---

## 3) ë‚´ë¶€ êµ¬ì¡°(í•„ë“œ) í•œ ë²ˆì— ë³´ê¸° ğŸ§±

`ClientRegistration`ì€ í¬ê²Œ 2ê°œì˜ ë©ì–´ë¦¬ë¡œ ìƒê°í•˜ë©´ ì´í•´ê°€ ì‰½ìŠµë‹ˆë‹¤.

### A) Registration(í´ë¼ì´ì–¸íŠ¸ ìì²´ ì •ë³´) ğŸ‘‡

* `registrationId` : `"google"`, `"github"` ê°™ì€ ë‚´ë¶€ ì‹ë³„ì
* `clientId`, `clientSecret`
* `redirectUri` : ë³´í†µ `{baseUrl}/login/oauth2/code/{registrationId}`
* `scope` : `profile`, `email` ë˜ëŠ” `read:user` ë“±
* `authorizationGrantType` : ë³´í†µ `authorization_code`
* `clientAuthenticationMethod` : `client_secret_basic` ë“±

### B) Provider(ê¶Œí•œ ì„œë²„ ì •ë³´) ğŸ‘‡

* `authorizationUri` : ê¶Œí•œ ë¶€ì—¬ ì—”ë“œí¬ì¸íŠ¸
* `tokenUri` : í† í° ì—”ë“œí¬ì¸íŠ¸
* `userInfoUri` : ì‚¬ìš©ì ì •ë³´ ì—”ë“œí¬ì¸íŠ¸(OAuth2)
* `userNameAttributeName` : ì‚¬ìš©ì ì‹ë³„ í‚¤(ì˜ˆ: google=`sub`)
* (OIDC) `issuerUri`, `jwkSetUri` : ID Token ê²€ì¦/í‚¤ ì¡°íšŒ ğŸªª

---

## 4) â€œProvider vs Registrationâ€ì´ ì™œ ì¤‘ìš”í•œê°€? ğŸ§ 

ì‹¤ë¬´ì—ì„œ ì„¤ì •ì„ ì´í•´í•  ë•Œ ê°€ì¥ í”í•œ í˜¼ë™ì´:

* client ì„¤ì •(registration)ê³¼
* provider ì„¤ì •(provider)

ì´ ì„ì´ëŠ” ê²ƒì…ë‹ˆë‹¤.

âœ… ì •ë¦¬í•˜ë©´:

* **registration**: â€œë‚´ ì•±(í´ë¼ì´ì–¸íŠ¸) ì •ë³´â€
* **provider**: â€œìƒëŒ€ë°©(ê¶Œí•œ ì„œë²„) ì •ë³´â€

ì´ê±¸ ë¶„ë¦¬í•´ì„œ ë¨¸ë¦¬ì— ë„£ìœ¼ë©´ YAMLì´ í›¨ì”¬ ì½ê¸° ì‰¬ì›Œì§‘ë‹ˆë‹¤. ğŸ§©

---

## 5) Spring Boot YAMLì—ì„œ `ClientRegistration`ì´ ë§Œë“¤ì–´ì§€ëŠ” ê³¼ì • ğŸ§¾â¡ï¸ğŸ§ 

Spring Bootì—ì„œëŠ” ì•„ë˜ ì„¤ì •ì´ ë°”ì¸ë”©ë˜ì–´ `ClientRegistration` ê°ì²´ë¡œ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤.

```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: xxx
            client-secret: yyy
            scope: profile, email
        provider:
          google:
            user-name-attribute: sub
```

### âœ… ìƒì„± íë¦„

* `spring.security.oauth2.client.registration.*`
  â†’ `ClientRegistration`ì˜ registration ì˜ì—­ ì±„ì›€
* `spring.security.oauth2.client.provider.*`
  â†’ providerDetails ì˜ì—­ ì±„ì›€
* ìµœì¢…ì ìœ¼ë¡œ `ClientRegistrationRepository`ì— ì €ì¥ë¨ ğŸ—ƒï¸

---

## 6) `ClientRegistrationRepository`ì™€ì˜ ê´€ê³„ ğŸ—ƒï¸

`ClientRegistration`ì€ â€œí•˜ë‚˜ì˜ í´ë¼ì´ì–¸íŠ¸ ì„¤ì •â€ì´ê³ ,
`ClientRegistrationRepository`ëŠ” â€œì—¬ëŸ¬ ê°œë¥¼ ì €ì¥í•˜ëŠ” ì €ì¥ì†Œâ€ì…ë‹ˆë‹¤.

* ê¸°ë³¸ êµ¬í˜„: `InMemoryClientRegistrationRepository`
* ì¡°íšŒ ë°©ì‹:

  * `findByRegistrationId("google")`

ì¦‰, ë¡œê·¸ì¸ ìš”ì²­ì´ `/oauth2/authorization/google`ë¡œ ë“¤ì–´ì˜¤ë©´:

1. registrationId = `"google"`
2. repositoryì—ì„œ `ClientRegistration`ì„ ì°¾ê³ 
3. ê·¸ê±¸ë¡œ Authorization Requestë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.

---

## 7) ê°€ì¥ ì¤‘ìš”í•œ í•„ë“œ TOP 6 (ì‹¤ë¬´ ìš°ì„ ìˆœìœ„) â­

### 1) `registrationId` ğŸ·ï¸

* URLê³¼ ì§ì ‘ ì—°ê²°: `/oauth2/authorization/{registrationId}`
* `/login/oauth2/code/{registrationId}` ì½œë°±ë„ ì—°ê²°

### 2) `redirectUri` ğŸ”

* mismatch ë‚˜ë©´ ë¡œê·¸ì¸ ìì²´ê°€ ì•ˆ ë¨
* í”„ë¡ì‹œ/ALB í™˜ê²½ì—ì„œ baseUrl ë¬¸ì œë¡œ ìì£¼ í„°ì§ ğŸ’¥

### 3) `authorizationUri` / `tokenUri` ğŸŒ

* Provider ë©”íƒ€ì •ë³´ì˜ í•µì‹¬
* ì˜ëª»ë˜ë©´ code êµí™˜ ì‹¤íŒ¨

### 4) `scope` ğŸ«

* ë™ì˜ í™”ë©´/ê¶Œí•œ ë²”ìœ„ ê²°ì •
* OIDCë©´ `openid` í¬í•¨ ì—¬ë¶€ë¡œ OIDC ë™ì‘ ì—¬ë¶€ê°€ ë°”ë€œ ğŸªª

### 5) `userInfoUri` ğŸ‘¤ğŸ“¡

* OAuth2UserServiceê°€ í˜¸ì¶œí•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸
* ì—†ìœ¼ë©´ `DefaultOAuth2UserService`ê°€ ë™ì‘ ëª»í•¨(ë‹¨, OIDCëŠ” ID Token ê¸°ë°˜ìœ¼ë¡œ ë‹¤ë¥¸ íë¦„ ê°€ëŠ¥)

### 6) `userNameAttributeName` ğŸ·ï¸

* `OAuth2User.getName()`ì„ ê²°ì •í•˜ëŠ” â€œì‹ë³„ í‚¤â€
* Providerë§ˆë‹¤ ë‹¤ë¦„:

  * google: `sub`
  * github: `id`
  * naver: ë³´í†µ `response.id` í˜•íƒœ(ì¤‘ì²© íŒŒì‹± í•„ìš”) ğŸ§©

---

## 8) ì½”ë“œë¡œ `ClientRegistration`ì„ ë§Œë“œëŠ” ë°©ë²•(Builder) ğŸ› ï¸

YAML ë§ê³  ì½”ë“œë¡œ ì§ì ‘ êµ¬ì„±í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

```java
ClientRegistration google = ClientRegistration.withRegistrationId("google")
    .clientId("xxx")
    .clientSecret("yyy")
    .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)
    .redirectUri("{baseUrl}/login/oauth2/code/{registrationId}")
    .scope("profile", "email")
    .authorizationUri("https://accounts.google.com/o/oauth2/v2/auth")
    .tokenUri("https://oauth2.googleapis.com/token")
    .userInfoUri("https://openidconnect.googleapis.com/v1/userinfo")
    .userNameAttributeName("sub")
    .clientName("Google")
    .build();
```

ğŸ“Œ ì¥ì :

* ë™ì  êµ¬ì„±(í…Œë„ŒíŠ¸ë³„ provider ë¶„ê¸° ë“±)ì— ìœ ë¦¬ ğŸŒ
  ë‹¨ì :
* ìš´ì˜ í™˜ê²½ì—ì„œ ì„¤ì • ê´€ë¦¬ê°€ ì½”ë“œë¡œ ì„ì´ë©´ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆìŒ ğŸ§¨

---

## 9) OIDCì—ì„œ `issuer-uri`ë¥¼ ì“°ë©´ ë­ê°€ ë‹¬ë¼ì§€ë‚˜? ğŸªªâœ¨

ì‚¬ìš©ìê»˜ì„œ ì˜ˆì „ì— ì§ˆë¬¸í•˜ì…¨ë˜ **issuer-uri** íë¦„ê³¼ ì •í™•íˆ ì—°ê²°ë©ë‹ˆë‹¤.

OIDC ProviderëŠ” `/.well-known/openid-configuration`ì„ ì œê³µí•˜ê³ ,
Springì€ `issuer-uri`ë§Œ ìˆìœ¼ë©´ ë‹¤ìŒì„ ìë™ ë°œê²¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* authorization_endpoint
* token_endpoint
* userinfo_endpoint
* jwks_uri (ID Token ì„œëª… ê²€ì¦ í‚¤)
* issuer ë“±

ì¦‰:

âœ… `issuer-uri` = Provider ë©”íƒ€ë°ì´í„° ìë™ êµ¬ì„± íŠ¸ë¦¬ê±°
â†’ `ClientRegistration`ì˜ providerDetailsê°€ ìë™ìœ¼ë¡œ ë” í’ë¶€í•´ì§ ğŸ§ 

---

## ğŸ”Ÿ ì‹¤ë¬´ì—ì„œ ìì£¼ í„°ì§€ëŠ” ì´ìŠˆ TOP 7 âš ï¸ğŸ’¥

1. `user-name-attribute` ëˆ„ë½
   â†’ `OAuth2User.getName()` ê²°ì • ì‹¤íŒ¨/ì´ìƒ ë™ì‘

2. redirect-uri mismatch
   â†’ Provider ì½˜ì†” ë“±ë¡ URLê³¼ í•œ ê¸€ìë¼ë„ ë‹¤ë¥´ë©´ ì‹¤íŒ¨

3. í”„ë¡ì‹œ/ALB ë’¤ì—ì„œ baseUrl ê³„ì‚° ì˜¤ë¥˜
   â†’ ë‚´ë¶€ IPë¡œ redirect-uri ë§Œë“¤ì–´ì§

4. scopeì—ì„œ `openid` ë¹ ì¡ŒëŠ”ë° OIDCë¥¼ ê¸°ëŒ€í•¨
   â†’ ID Token íë¦„ì´ ì•ˆ ë‚˜ì™€ì„œ í˜¼ë€

5. github email null
   â†’ attributes íŒŒì‹±/ê°€ì… ë¡œì§ì—ì„œ NPE

6. providerë³„ userInfo ì‘ë‹µ êµ¬ì¡° ì¤‘ì²©
   â†’ ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ì—ì„œ Map íŒŒì‹± í•„ìš”

7. client authentication method ë¶ˆì¼ì¹˜
   â†’ token endpointì—ì„œ invalid_client

---

## 11) í•œ ì¤„ ê²°ë¡  âœï¸âœ…

> `ClientRegistration`ì€ Spring Security OAuth2 Loginì˜ â€œì„¤ì • í•µì‹¬ ê°ì²´â€ë¡œ, ë¡œê·¸ì¸ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¶€í„° í† í° êµí™˜, UserInfo í˜¸ì¶œ, Principal ì‹ë³„(getName)ê¹Œì§€ ì „ì²´ ë™ì‘ì„ ê²°ì •í•œë‹¤.

---

### ì°¸ê³  ì‚¬í•­ ğŸ§°ğŸ”¥

* âœ… `ClientRegistration`ì´ ì‹¤ì œë¡œ **OAuth2AuthorizationRequest**ë¡œ ë³€í™˜ë˜ëŠ” ê³¼ì •(Resolver)
* âœ… `userNameAttributeName`ì´ `DefaultOAuth2User#getName()`ì— ë“¤ì–´ê°€ëŠ” ì •í™•í•œ íë¦„
* âœ… ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ê¹Œì§€ í¬í•¨í•œ providerë³„ `ClientRegistration` ì„¤ì • ì˜ˆì‹œ + attributes íŒŒì‹± í…œí”Œë¦¿
