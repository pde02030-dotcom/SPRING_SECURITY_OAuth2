# Spring Security `OAuth2UserService` / `OidcUserService` ë‚´ë¶€ ë™ì‘ (ì½”ë“œ ë ˆë²¨) ğŸ”ğŸ”

(= â€œí† í° ë°›ê³  ë‚˜ì„œ **UserInfo**ëŠ” ëˆ„ê°€/ì–¸ì œ/ì–´ë–»ê²Œ í˜¸ì¶œí•˜ê³  Principalì„ ë§Œë“¤ê¹Œ?â€)

Spring Security OAuth2 Loginì—ì„œ **ì‚¬ìš©ì(Principal)ë¥¼ ìµœì¢… ìƒì„±**í•˜ëŠ” í•µì‹¬ ì¶•ì€ ì•„ë˜ 2ê°œì…ë‹ˆë‹¤. ğŸ§©

* `OAuth2UserService<OAuth2UserRequest, OAuth2User>`

  * ë””í´íŠ¸ êµ¬í˜„: `DefaultOAuth2UserService`
* `OAuth2UserService<OidcUserRequest, OidcUser>`

  * ë””í´íŠ¸ êµ¬í˜„: `OidcUserService` (ë‚´ë¶€ì ìœ¼ë¡œ `DefaultOAuth2UserService`ë¥¼ ë§ì´ í™œìš©)

ì´ ë‘˜ì€ `OAuth2LoginAuthenticationProvider` ì•ˆì—ì„œ í˜¸ì¶œë˜ë©°, **UserInfo Endpoint í˜¸ì¶œ â†’ attributes/claims êµ¬ì„± â†’ OAuth2User/OidcUser ìƒì„±**ê¹Œì§€ ì±…ì„ì§‘ë‹ˆë‹¤. ğŸ—ï¸

---

## 1) í˜¸ì¶œ ìœ„ì¹˜: ì–´ë””ì„œ `userService.loadUser()`ê°€ ë¶ˆë¦¬ë‚˜? ğŸ§­

íë¦„ì„ Provider ê´€ì ìœ¼ë¡œ ìª¼ê°œë©´:

```text
OAuth2LoginAuthenticationFilter
  â†’ OAuth2LoginAuthenticationProvider.authenticate()
       1) accessTokenResponseClientë¡œ Access Token êµí™˜
       2) (OIDCë©´) ID Token ê²€ì¦ ë° OidcUserRequest êµ¬ì„±
       3) userService.loadUser(userRequest) í˜¸ì¶œ  â­ ì—¬ê¸°!
       4) OAuth2AuthenticationToken ìƒì„± + SecurityContext ì €ì¥
```

ì¦‰, **â€œUserInfo ê°€ì ¸ì™€ì„œ Principal ë§Œë“¤ê¸°â€ëŠ” Providerì˜ authenticate() ì¤‘ê°„ì—ì„œ ì¼ì–´ë‚©ë‹ˆë‹¤.** âœ…

---

## 2) `OAuth2UserService` (DefaultOAuth2UserService) ë‚´ë¶€ ë™ì‘ ğŸ”§

### âœ… ì…ë ¥: `OAuth2UserRequest`

`OAuth2UserRequest`ì—ëŠ” ìµœì†Œ ì•„ë˜ê°€ ë“¤ì–´ìˆìŠµë‹ˆë‹¤.

* `ClientRegistration` (provider ì„¤ì •: userInfoUri, userNameAttributeName ë“±)
* `OAuth2AccessToken` (UserInfo í˜¸ì¶œì— ì‚¬ìš©)
* (ì„ íƒ) AdditionalParameters

---

### âœ… DefaultOAuth2UserServiceì˜ í•µì‹¬ ì•Œê³ ë¦¬ì¦˜ (ì˜ì‚¬ì½”ë“œ) ğŸ§ 

ì•„ë˜ëŠ” ì‹¤ì œ êµ¬ì¡°ë¥¼ â€œí”„ë ˆì„ì›Œí¬ ì½”ë“œ ëŠë‚Œâ€ìœ¼ë¡œ ì¬êµ¬ì„±í•œ í•µì‹¬ ë¡œì§ì…ë‹ˆë‹¤.

```java
OAuth2User loadUser(OAuth2UserRequest req) {

  ClientRegistration reg = req.getClientRegistration();

  // 1) userInfoEndpoint ì„¤ì • ì²´í¬
  String userInfoUri = reg.getProviderDetails()
                          .getUserInfoEndpoint()
                          .getUri();
  if (!hasText(userInfoUri)) {
     // OIDCê°€ ì•„ë‹Œ ìˆœìˆ˜ OAuth2ì¸ë° userInfoUriê°€ ì—†ìœ¼ë©´ ì‚¬ì‹¤ìƒ userë¥¼ ëª» ë§Œë“¦
     throw new OAuth2AuthenticationException("missing_userinfo_uri");
  }

  // 2) Access Tokenìœ¼ë¡œ UserInfo í˜¸ì¶œ ìš”ì²­ ë§Œë“¤ê¸°
  RequestEntity<?> request = buildUserInfoRequest(reg, req.getAccessToken());
  // ê¸°ë³¸: Authorization: Bearer <token>

  // 3) RestOperations(RestTemplate)ë¡œ í˜¸ì¶œ
  ResponseEntity<Map<String,Object>> response = rest.exchange(request, ...);

  Map<String,Object> attributes = response.getBody();

  // 4) "ì´ ì‚¬ìš©ìì˜ name"ì— í•´ë‹¹í•˜ëŠ” attribute key í™•ì¸
  String nameAttrKey = reg.getProviderDetails()
                          .getUserInfoEndpoint()
                          .getUserNameAttributeName();
  if (!attributes.containsKey(nameAttrKey)) {
     throw new OAuth2AuthenticationException("missing_name_attribute");
  }

  // 5) authorities êµ¬ì„± (UserInfo ê¸°ë°˜ OAuth2UserAuthority + scope ê¸°ë°˜ SCOPE_*)
  Collection<GrantedAuthority> authorities = buildAuthorities(reg, attributes, req.getAccessToken());

  // 6) DefaultOAuth2User ìƒì„±
  return new DefaultOAuth2User(authorities, attributes, nameAttrKey);
}
```

---

### ğŸ”¥ í¬ì¸íŠ¸ 1) UserInfo ìš”ì²­ì€ ì–´ë–»ê²Œ ë§Œë“¤ì–´ì§€ë‚˜? ğŸ“¡

* ê¸°ë³¸ì€ `Authorization: Bearer <access_token>`
* Providerì— ë”°ë¼ ì¶”ê°€ íŒŒë¼ë¯¸í„°/í—¤ë”ê°€ í•„ìš”í•  ìˆ˜ ìˆì–´ ì»¤ìŠ¤í„°ë§ˆì´ì§• í¬ì¸íŠ¸ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.

---

### ğŸ”¥ í¬ì¸íŠ¸ 2) nameAttributeKeyê°€ ì™œ ì¤‘ìš”í•˜ë‚˜? ğŸ”‘

`DefaultOAuth2User.getName()`ì€ ê²°êµ­:

* `attributes.get(nameAttributeKey).toString()`

ì´ê¸° ë•Œë¬¸ì—, nameAttributeKeyê°€ ì˜ëª»ë˜ë©´:

* Principal ì‹ë³„ì´ ê¹¨ì§€ê³ 
* ë‚´ë¶€ ì„¸ì…˜ ì €ì¥/ì—°ë™ ë¡œì§ì—ì„œ í˜¼ë€ì´ ìƒê¹ë‹ˆë‹¤. ğŸ§¨

---

### ğŸ”¥ í¬ì¸íŠ¸ 3) authoritiesëŠ” ì–´ë–»ê²Œ ìŒ“ì´ë‚˜? ğŸ›¡ï¸

ë³´í†µ 2ì¢…ë¥˜ê°€ ì„ì…ë‹ˆë‹¤.

1. `OAuth2UserAuthority`

* UserInfo attributes ì „ì²´ë¥¼ í¬í•¨(â€œì´ ì‚¬ìš©ì ì •ë³´ ë©ì–´ë¦¬â€ ìì²´ê°€ í•˜ë‚˜ì˜ authorityì²˜ëŸ¼ ë“¤ì–´ê°)

2. `SCOPE_xxx` í˜•íƒœ

* access tokenì˜ scopeë¥¼ `GrantedAuthority`ë¡œ ë³€í™˜
  ì˜ˆ: `scope: profile email` â†’ `SCOPE_profile`, `SCOPE_email`

---

## 3) `OidcUserService` ë‚´ë¶€ ë™ì‘ ğŸªªâœ¨

OIDCëŠ” OAuth2 ìœ„ì— â€œì¸ì¦â€ì´ ì–¹íŒ êµ¬ì¡°ì´ë¯€ë¡œ ì²˜ë¦¬ ë‹¨ê³„ê°€ ì¶”ê°€ë©ë‹ˆë‹¤.

### âœ… ì…ë ¥: `OidcUserRequest`

* `ClientRegistration`
* `AccessToken`
* **`OidcIdToken`** â­ (id_token íŒŒì‹±/ê²€ì¦ ê²°ê³¼)
* (ì„ íƒ) `OidcUserInfo` (UserInfo í˜¸ì¶œ ê²°ê³¼)

---

### âœ… OidcUserServiceì˜ í•µì‹¬ ì•Œê³ ë¦¬ì¦˜ (ì˜ì‚¬ì½”ë“œ) ğŸ§ 

```java
OidcUser loadUser(OidcUserRequest req) {

  ClientRegistration reg = req.getClientRegistration();

  // 1) ID Token claims í™•ë³´ (ì´ë¯¸ ì• ë‹¨ê³„ì—ì„œ ê²€ì¦ë¨)
  OidcIdToken idToken = req.getIdToken();
  Map<String,Object> idClaims = idToken.getClaims();

  // 2) UserInfo í˜¸ì¶œ ì—¬ë¶€ íŒë‹¨
  //    - userInfoUriê°€ ìˆëŠ”ì§€
  //    - scopeì— openid/profile/email ë“±ì´ ìˆëŠ”ì§€
  //    - provider ì„¤ì •/ì¡°ê±´(ë³´í†µ "ê°€ëŠ¥í•˜ë©´ í˜¸ì¶œ") ë“±
  OidcUserInfo userInfo = null;
  if (shouldRetrieveUserInfo(reg, req)) {

     // ë‚´ë¶€ì ìœ¼ë¡œ DefaultOAuth2UserService ìŠ¤íƒ€ì¼ë¡œ í˜¸ì¶œí•¨(Access Token ì‚¬ìš©)
     Map<String,Object> userInfoClaims = fetchUserInfo(reg, req.getAccessToken());

     userInfo = new OidcUserInfo(userInfoClaims);

     // 3) í•µì‹¬ ê²€ì¦: sub ë§¤ì¹­ (OIDC ê·œì¹™)
     //    - UserInfoì˜ sub == ID Tokenì˜ sub ì´ì–´ì•¼ í•¨
     if (!Objects.equals(userInfo.getSubject(), idToken.getSubject())) {
        throw new OAuth2AuthenticationException("invalid_userinfo_response");
     }
  }

  // 4) authorities êµ¬ì„±
  //    - OIDC UserAuthority (idToken + userInfo)
  //    - scope ê¸°ë°˜ SCOPE_*
  Collection<GrantedAuthority> authorities = buildOidcAuthorities(req, userInfo);

  // 5) DefaultOidcUser ìƒì„±
  //    nameì€ ë³´í†µ sub ê¸°ë°˜(í˜¹ì€ ì„¤ì •ëœ í‚¤)
  return new DefaultOidcUser(authorities, idToken, userInfo, "sub");
}
```

---

### ğŸ”¥ í¬ì¸íŠ¸ 1) OIDCëŠ” â€œsub ì¼ì¹˜ ê²€ì¦â€ì´ ë§¤ìš° ì¤‘ìš” ğŸ§·

OIDCì—ì„œëŠ” **ID Tokenì˜ sub**ì™€ **UserInfoì˜ sub**ê°€ ë‹¤ë¥´ë©´
ê·¸ UserInfo ì‘ë‹µì€ **ì‹ ë¢°í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.** âŒ

ê·¸ë˜ì„œ `OidcUserService`ëŠ” ì´ ë¶€ë¶„ì„ ê°•í•˜ê²Œ ì²´í¬í•©ë‹ˆë‹¤.

---

### ğŸ”¥ í¬ì¸íŠ¸ 2) OIDCì˜ authorities êµ¬ì„±ì€ â€œUserAuthorityâ€ ì¤‘ì‹¬ ğŸ›¡ï¸

OIDCëŠ” ë³´í†µ ë‹¤ìŒì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.

* `OidcUserAuthority`

  * ë‚´ë¶€ì— id_token, userinfo claimsê°€ ê°™ì´ í¬í•¨
* `SCOPE_*` authorities

ì¦‰ OIDCëŠ” â€œì¸ì¦ì— í•„ìš”í•œ ì‹ ë¢° ë‹¨ìœ„â€ë¥¼ authorityì—ë„ ë°˜ì˜í•©ë‹ˆë‹¤. ğŸ”

---

## 4) OAuth2 vs OIDC: ë‚´ë¶€ ë™ì‘ ì°¨ì´ í•œ ë°©ì— ì •ë¦¬ ğŸ§¾âœ…

| í•­ëª©        | DefaultOAuth2UserService      | OidcUserService                        |
| --------- | ----------------------------- | -------------------------------------- |
| ì…ë ¥        | OAuth2UserRequest             | OidcUserRequest(id_token í¬í•¨)           |
| ì‚¬ìš©ìì •ë³´ ì¶œì²˜  | UserInfo Endpoint(Map)        | ID Token claims + (ì„ íƒ) UserInfo claims |
| í•µì‹¬ ê²€ì¦     | nameAttributeKey ì¡´ì¬           | **sub ì¼ì¹˜ ê²€ì¦**                          |
| Principal | DefaultOAuth2User             | DefaultOidcUser                        |
| ê¶Œí•œ êµ¬ì„±     | OAuth2UserAuthority + SCOPE_* | OidcUserAuthority + SCOPE_*            |

---

## 5) ì‹¤ë¬´ì—ì„œ â€œì»¤ìŠ¤í„°ë§ˆì´ì§•â€ì€ ë³´í†µ ì–´ë””ë¥¼ ê±´ë“œë¦¬ë‚˜? ğŸ”§

### âœ… 1) â€œattributes ì •ê·œí™”â€ (Providerë³„ í‚¤ í†µì¼) ğŸ§±

* Google: `sub`
* GitHub: `id`
* Naver/Kakao: ì¤‘ì²© êµ¬ì¡°

â¡ï¸ `OAuth2UserService`ë¥¼ ì»¤ìŠ¤í…€í•´ì„œ `attributes`ë¥¼ ë³€í™˜í•œ ë’¤ `DefaultOAuth2User`ë¥¼ ìƒì„±í•˜ëŠ” íŒ¨í„´ì´ ê°€ì¥ í”í•©ë‹ˆë‹¤.

---

### âœ… 2) â€œUserInfo í˜¸ì¶œ ì¡°ê±´/ë°©ì‹â€ ì œì–´ ğŸ“¡

* ì–´ë–¤ providerëŠ” UserInfo í˜¸ì¶œì´ ëŠë¦¬ê±°ë‚˜ ì œí•œì´ ìˆìŒ
* ì–´ë–¤ providerëŠ” ì¶”ê°€ í—¤ë” í•„ìš”

â¡ï¸ `RestOperations`/request converterë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•˜ëŠ” ì§€ì ì´ ì‹¤ë¬´ í¬ì¸íŠ¸ì…ë‹ˆë‹¤.

---

### âœ… 3) ë‚´ë¶€ ì‚¬ìš©ì(User Entity)ì™€ ë§¤í•‘ + ìë™ íšŒì›ê°€ì…(Provisioning) ğŸ§¾

* `(provider, sub)`ë¡œ DB ì‚¬ìš©ì ì¡°íšŒ
* ì—†ìœ¼ë©´ ìë™ ìƒì„±
* ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸(ì´ë¦„/ì‚¬ì§„ ë³€ê²½ ë°˜ì˜ ë“±)

