# OAuth 2.0 Authorization Code Grant + OpenID Connect(OIDC)
```
http://127.0.0.1:7070/oauth2/authorize?response_type=code&client_id=client&scope=openid&state=Qno-l29ZJKTmbQgF3HcQPBpmDPdyO4CRGp7pZbeU_UA%3D&redirect_uri=http://localhost:8080/login/oauth2/code/my_authorization_server&nonce=quIQTHv8eWyy-zEoOwlk9_hXb4vzgBOK_Nlzpsjs41s
```

ìœ„ URLì€ **OAuth 2.0 Authorization Code Grant + OpenID Connect(OIDC)** ë¡œ â€œë¡œê·¸ì¸(ì¸ì¦) + ê¶Œí•œë¶€ì—¬ ì½”ë“œ ë°œê¸‰â€ì„ ìš”ì²­í•˜ëŠ” **Authorization Endpoint í˜¸ì¶œ URL** ì…ë‹ˆë‹¤.
ì¦‰, **í´ë¼ì´ì–¸íŠ¸(ì˜ˆ: localhost:8080 ì•±)** ê°€ **ê¶Œí•œ ì„œë²„(127.0.0.1:7070)** ì—ê²Œ

> â€œì‚¬ìš©ì ë¡œê·¸ì¸ ì‹œí‚¤ê³ , ì„±ê³µí•˜ë©´ `code`(ê¶Œí•œë¶€ì—¬ ì½”ë“œ) ë°œê¸‰í•´ì„œ ì´ redirect_urië¡œ ëŒë ¤ë³´ë‚´ì¤˜ìš”â€

ë¼ê³  ìš”ì²­í•˜ëŠ” ê²ë‹ˆë‹¤. ğŸ˜Š

---

## 1) ì „ì²´ êµ¬ì¡°

```
http://127.0.0.1:7070/oauth2/authorize
  ?response_type=code
  &client_id=client
  &scope=openid
  &state=...
  &redirect_uri=http://localhost:8080/login/oauth2/code/my_authorization_server
  &nonce=...
```

* **í˜¸ìŠ¤íŠ¸/í¬íŠ¸(127.0.0.1:7070)**: Authorization Server (Spring Authorization Server)
* **ê²½ë¡œ(/oauth2/authorize)**: Authorization Endpoint
  â†’ ì‚¬ìš©ìë¥¼ ë¡œê·¸ì¸ì‹œí‚¤ê³ , ë™ì˜(consent) ë°›ê³ , **Authorization Code** ë¥¼ ë°œê¸‰í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸

---

## 2) íŒŒë¼ë¯¸í„° í•˜ë‚˜ì”© í•´ì„ ğŸ”

### âœ… `response_type=code`

* â€œ**Authorization Code** ë¥¼ ë‹¬ë¼â€ëŠ” ëœ»
* Authorization Code Grantì˜ í•µì‹¬ íŒŒë¼ë¯¸í„°

---

### âœ… `client_id=client`

* ê¶Œí•œ ì„œë²„ì— ë“±ë¡ëœ **í´ë¼ì´ì–¸íŠ¸ ì‹ë³„ì**
* ì§ˆë¬¸ì— ì˜¬ë¦° ì„œë²„ ì½”ë“œì—ì„œ:

  ```java
  .clientId("client")
  ```

---

### âœ… `scope=openid`

* ì´ ìš”ì²­ì´ ë‹¨ìˆœ OAuth2ê°€ ì•„ë‹ˆë¼ **OIDC ë¡œê·¸ì¸ ìš”ì²­**ì„ì„ ì˜ë¯¸
* `openid` ìŠ¤ì½”í”„ê°€ ë“¤ì–´ê°€ë©´:

  * ê²°ê³¼ì ìœ¼ë¡œ í† í° êµí™˜ ë‹¨ê³„ì—ì„œ **ID Token** ë°œê¸‰ì´ ê°€ëŠ¥í•´ì§
  * ê·¸ë¦¬ê³  `nonce` ê°™ì€ OIDC ì „ìš© íŒŒë¼ë¯¸í„°ê°€ ë“±ì¥í•¨

ì„œë²„ ì½”ë“œì—ì„œë„:

```java
.scope(OidcScopes.OPENID)
```

---

### âœ… `redirect_uri=http://localhost:8080/login/oauth2/code/my_authorization_server`

* â€œì¸ê°€ ì½”ë“œ ë°œê¸‰í•˜ë©´ **ì´ ì£¼ì†Œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•´ì¤˜**â€ë¼ëŠ” ëœ»
* ë“±ë¡ëœ redirect_uriì™€ **ì™„ì „íˆ ì¼ì¹˜**í•´ì•¼ í•¨ (ë¬¸ì í•˜ë‚˜ë¼ë„ ë‹¤ë¥´ë©´ reject)

ì„œë²„ ì½”ë“œì—ì„œ:

```java
.redirectUri("http://localhost:8080/login/oauth2/code/my_authorization_server")
```

---

### âœ… `state=...`

* **CSRF ë°©ì–´ + ìš”ì²­/ì‘ë‹µ ë§¤ì¹­** ìš© ëœë¤ ê°’
* íë¦„:

  1. í´ë¼ì´ì–¸íŠ¸ê°€ state ìƒì„±í•´ì„œ authorize ìš”ì²­ì— í¬í•¨
  2. ê¶Œí•œ ì„œë²„ê°€ redirectí•  ë•Œ stateë¥¼ ê·¸ëŒ€ë¡œ ëŒë ¤ì¤Œ
  3. í´ë¼ì´ì–¸íŠ¸ëŠ” ëŒì•„ì˜¨ stateê°€ â€œë‚´ê°€ ë³´ë‚¸ ê²ƒâ€ê³¼ ê°™ì€ì§€ ê²€ì‚¬
     â†’ ë‹¤ë¥´ë©´ ê³µê²©/ì˜¤ì—¼ìœ¼ë¡œ ë³´ê³  ì‹¤íŒ¨ ì²˜ë¦¬

---

### âœ… `nonce=...`

* **OIDC ì „ìš© íŒŒë¼ë¯¸í„°**
* ëª©ì : **ID Token ì¬ì‚¬ìš©(Replay) ê³µê²© ë°©ì–´**
* íë¦„:

  1. í´ë¼ì´ì–¸íŠ¸ê°€ nonce ìƒì„±í•´ì„œ authorize ìš”ì²­ì— í¬í•¨
  2. ë‚˜ì¤‘ì— ID Tokenì´ ë°œê¸‰ë˜ë©´ ê·¸ ì•ˆì˜ claimì— `nonce`ê°€ í¬í•¨ë¨
  3. í´ë¼ì´ì–¸íŠ¸ëŠ” **ID Tokenì˜ nonce == ë‚´ê°€ ë³´ë‚¸ nonce**ì¸ì§€ ê²€ì¦
     â†’ ë‹¤ë¥´ë©´ â€œëˆ„ê°€ ì˜ˆì „ í† í°ì„ ì¬ì‚¬ìš©/ë¼ì›Œë„£ì—ˆë‹¤â€ë¡œ íŒë‹¨

> ì°¸ê³ : nonceëŠ” **Authorization Code ìì²´**ë¥¼ ë³´í˜¸í•œë‹¤ê¸°ë³´ë‹¨, **ID Tokenì˜ ì•ˆì „ì„±**ì„ ê°•í™”í•©ë‹ˆë‹¤.

---

## 3) ì´ URLì„ í˜¸ì¶œí•˜ë©´ ì‹¤ì œë¡œ ë¬´ìŠ¨ ì¼ì´ ë²Œì–´ì§€ë‚˜? ğŸ§­

1. ë¸Œë¼ìš°ì €ê°€ `GET /oauth2/authorize?...` ë¡œ ê¶Œí•œ ì„œë²„ì— ì ‘ê·¼
2. ê¶Œí•œ ì„œë²„ê°€ ì‚¬ìš©ì ì„¸ì…˜ì´ ì—†ìœ¼ë©´ â†’ `/login` ìœ¼ë¡œ ë³´ëƒ„
3. ë¡œê·¸ì¸ ì„±ê³µí•˜ë©´ (ê·¸ë¦¬ê³  consent í•„ìš”í•˜ë©´ consent í™”ë©´)
4. ìµœì¢…ì ìœ¼ë¡œ ê¶Œí•œ ì„œë²„ê°€ **redirect_uri** ë¡œ 302 ë¦¬ë‹¤ì´ë ‰íŠ¸:

   ```
   http://localhost:8080/login/oauth2/code/my_authorization_server
     ?code=xxxx
     &state=ì›ë˜state
   ```
5. í´ë¼ì´ì–¸íŠ¸(8080)ëŠ” `code`ë¥¼ ë“¤ê³  `/oauth2/token` ìœ¼ë¡œ í† í° êµí™˜
6. ì„±ê³µí•˜ë©´ Access Token(+ OIDCë©´ ID Token) íšë“ â†’ ë¡œê·¸ì¸ ì™„ë£Œ

---

## 4) â€œì´ URLì€ ëˆ„ê°€ ë§Œë“œëŠ”ê°€?â€

ëŒ€ë¶€ë¶„ ì§ì ‘ ì‘ì„±í•˜ëŠ” ê²Œ ì•„ë‹ˆë¼, **Spring Security OAuth2 Client**ê°€ ìë™ ìƒì„±í•©ë‹ˆë‹¤.

* ì‚¬ìš©ìê°€ `/oauth2/authorization/{registrationId}` ë¡œ ì§„ì…í•˜ë©´
* Spring Securityê°€ ë“±ë¡ ì •ë³´(ClientRegistration)ë¥¼ ì½ê³ 
* authorize URLì„ ì¡°ë¦½í•´ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•©ë‹ˆë‹¤.

---

## 5) `/oauth2/authorize?...` URLì´ **Spring Security(OAuth2 Client)** ë‚´ë¶€ì—ì„œ â€œì–´ë””ì„œ, ì–´ë–»ê²Œâ€ ì¡°ë¦½ë¼ì„œ ë¸Œë¼ìš°ì €ë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸ì‹œí‚¤ëŠ”ì§€ **í•„í„°/í´ë˜ìŠ¤ ê¸°ì¤€ì˜ ì½”ë“œ íë¦„ë„** ğŸ˜Š

---

### (1) ì „ì œ: ê·¸ URLì€ â€œëˆ„ê°€â€ ë§Œë“¤ì—ˆë‚˜?

ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì‚¬ìš©ìê°€ ì§ì ‘ ë§Œë“¤ì§€ ì•Šê³ , í´ë¼ì´ì–¸íŠ¸(ì˜ˆ: `localhost:8080`)ì—ì„œ

* `GET /oauth2/authorization/{registrationId}`

ë¡œ ì§„ì…í•˜ë©´ Spring Securityê°€ **ClientRegistration**ì„ ê¸°ë°˜ìœ¼ë¡œ **Authorization Request**ë¥¼ ë§Œë“¤ê³ ,
ê·¸ ê²°ê³¼ë¡œ

* `302 Location: http://127.0.0.1:7070/oauth2/authorize?...`

ë¥¼ ë§Œë“¤ì–´ ë¸Œë¼ìš°ì €ë¥¼ ë³´ë‚´ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.

---

### (2) ì „ì²´ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ (ìš”ì²­ íë¦„ë„)

```text
[Browser]
   |
   | 1) GET /oauth2/authorization/my_authorization_server
   v
[Security Filter Chain]
   |
   | 2) OAuth2AuthorizationRequestRedirectFilter ê°€ ê°€ë¡œì±”
   v
[OAuth2AuthorizationRequestRedirectFilter]
   |
   | 3) AuthorizationRequestResolver.resolve(request)
   v
[DefaultOAuth2AuthorizationRequestResolver]
   |
   | 4) ClientRegistrationRepository.findByRegistrationId(...)
   v
[ClientRegistration]  (issuer/authorization-uri/client-id/redirect-uri/scopes ë“± ë³´ìœ )
   |
   | 5) OAuth2AuthorizationRequest ìƒì„± + state/nonce ìƒì„± + redirect_uri ê³„ì‚°
   v
[OAuth2AuthorizationRequest]
   |
   | 6) AuthorizationRequestRepository.saveAuthorizationRequest(...)
   v
[HttpSessionOAuth2AuthorizationRequestRepository]
   |
   | 7) RedirectStrategy ë¡œ 302 Location ì „ì†¡
   v
[Browser] -----> http://127.0.0.1:7070/oauth2/authorize?....
```

---

### (3) í•µì‹¬ ì—”íŠ¸ë¦¬: `OAuth2AuthorizationRequestRedirectFilter`

ì´ í•„í„°ê°€ ì‚¬ì‹¤ìƒ â€œì‹œì‘ ë²„íŠ¼â€ì…ë‹ˆë‹¤.

#### âœ… ì—­í• 

* `/oauth2/authorization/{registrationId}` ìš”ì²­ì„ ê°ì§€
* `{registrationId}`ë¡œ `ClientRegistration`ì„ ì°¾ìŒ
* **Authorization Request**ë¥¼ ë§Œë“¤ê³ (= authorize URL ë§Œë“¤ ì¬ë£Œ êµ¬ì„±)
* state/nonce ë“±ì„ í¬í•¨í•´ ì €ì¥í•˜ê³ 
* ìµœì¢…ì ìœ¼ë¡œ **Authorization Serverì˜ authorize endpointë¡œ 302 ë¦¬ë‹¤ì´ë ‰íŠ¸**

#### ğŸ”‘ í¬ì¸íŠ¸

* ì—¬ê¸°ì„œ â€œURL ë¬¸ìì—´â€ì„ ì§ì ‘ í•˜ë“œì½”ë”©í•´ì„œ ë§Œë“¤ê¸°ë³´ë‹¤,
  `OAuth2AuthorizationRequest`(ê°ì²´)ë¥¼ ë§Œë“  ë’¤ **ê·¸ ê°ì²´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Redirect URLì„ êµ¬ì„±**í•©ë‹ˆë‹¤.

---

### (4) URL ì¡°ë¦½ ë‹´ë‹¹: `DefaultOAuth2AuthorizationRequestResolver`

ì´ í´ë˜ìŠ¤ê°€ â€œauthorize URLì„ ë§Œë“¤ê¸° ìœ„í•œ íŒŒë¼ë¯¸í„°ë¥¼ ì„¸íŒ…â€í•˜ëŠ” í•µì‹¬ì…ë‹ˆë‹¤.

#### âœ… í•˜ëŠ” ì¼

1. ìš”ì²­ ê²½ë¡œì—ì„œ `registrationId` ì¶”ì¶œ

   * ì˜ˆ: `/oauth2/authorization/my_authorization_server` â†’ `my_authorization_server`

2. `ClientRegistrationRepository`ì—ì„œ ë“±ë¡ ì •ë³´ ë¡œë“œ

   * clientId
   * authorizationUri (ì˜ˆ: `http://127.0.0.1:7070/oauth2/authorize`)
   * redirectUri í…œí”Œë¦¿ (ì˜ˆ: `{baseUrl}/login/oauth2/code/{registrationId}`)
   * scope (openid ë“±)

3. `OAuth2AuthorizationRequest` ìƒì„±

   * `response_type=code`
   * `client_id=...`
   * `scope=...`
   * `redirect_uri=...` (ì—¬ê¸°ì„œ ìµœì¢… ê³„ì‚°ë¨)
   * `state=...` (ëœë¤ ìƒì„±)
   * OIDCë©´ `nonce=...` (OIDC ìš”ì²­ì¼ ë•Œ ìƒì„±/ì¶”ê°€)

---

### (5) `ClientRegistration`ì´ í•˜ëŠ” ì—­í• 

`ClientRegistration`ì€ â€œauthorize URLì„ ë§Œë“¤ê¸° ìœ„í•œ ì„¤ê³„ë„(ë“±ë¡ì •ë³´)â€ì…ë‹ˆë‹¤.

#### ì˜ˆì‹œë¡œ ë§¤í•‘í•´ë³´ë©´

* `client_id=client`  â† `ClientRegistration.getClientId()`
* `authorizationUri=/oauth2/authorize` â† `providerDetails.authorizationUri`
* `redirect_uri=http://localhost:8080/login/oauth2/code/my_authorization_server`

  * ì´ ê°’ì€ ë³´í†µ **redirectUri í…œí”Œë¦¿** + í˜„ì¬ ìš”ì²­ì˜ baseUrl ì¡°í•©ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.
* `scope=openid` â† `ClientRegistration.getScopes()`

---

### (6) `state`ì™€ `nonce`ëŠ” ì–´ë””ì— ì €ì¥ë˜ë‚˜?

ì—¬ê¸°ê°€ â€œì™œ ì €ì¥ì´ í•„ìš”í•˜ì§€?â€ì˜ í•µì‹¬ì…ë‹ˆë‹¤.

#### âœ… ì €ì¥ ì´ìœ 

Authorization Serverê°€ redirectë¡œ ëŒë ¤ì¤„ ë•Œ

* `code=...`
* `state=...`

ë¥¼ ëŒë ¤ì£¼ëŠ”ë°, í´ë¼ì´ì–¸íŠ¸ëŠ”

* **ë‚´ê°€ ì²˜ìŒ ë§Œë“¤ì—ˆë˜ stateì™€ ê°™ì€ì§€** ê²€ì¦í•´ì•¼ í•©ë‹ˆë‹¤. (CSRF ë°©ì–´)

OIDCë©´ ID Token ê²€ì¦ ì‹œì—ë„

* **nonce ì¼ì¹˜ ì—¬ë¶€**ë¥¼ ê²€ì¦í•´ì•¼ í•©ë‹ˆë‹¤. (Replay ë°©ì–´)

#### âœ… ì €ì¥ ìœ„ì¹˜ ê¸°ë³¸ êµ¬í˜„

* `HttpSessionOAuth2AuthorizationRequestRepository`

  * ì¦‰, **ì„¸ì…˜(HttpSession)ì— OAuth2AuthorizationRequestë¥¼ ì €ì¥**í•´ë‘ì—ˆë‹¤ê°€
  * ì½œë°±(`/login/oauth2/code/...`)ì—ì„œ êº¼ë‚´ ê²€ì¦í•©ë‹ˆë‹¤.

---

### (7) ìµœì¢… 302 ë¦¬ë‹¤ì´ë ‰íŠ¸ëŠ” ëˆ„ê°€ ìˆ˜í–‰?

`OAuth2AuthorizationRequestRedirectFilter`ê°€ ë§ˆì§€ë§‰ì— ë³´í†µ ì´ëŸ° ì¼ì„ í•©ë‹ˆë‹¤.

* `RedirectStrategy.sendRedirect(request, response, authorizationRequestUri)`

ì¦‰, ë¸Œë¼ìš°ì €ê°€ ì‹¤ì œë¡œ ë³´ê²Œ ë˜ëŠ” ì´ URL:

`http://127.0.0.1:7070/oauth2/authorize?response_type=code&...`

ì€ ìµœì¢…ì ìœ¼ë¡œ **302 Location í—¤ë”**ë¡œ ë‚´ë ¤ê°„ ê²°ê³¼ì…ë‹ˆë‹¤.

---

### (8) â€œí•œ ì¤„ ìš”ì•½â€ìœ¼ë¡œ íë¦„ ì¬ì •ë¦¬

* `/oauth2/authorization/{registrationId}` ìš”ì²­
* â†’ `OAuth2AuthorizationRequestRedirectFilter`
* â†’ `DefaultOAuth2AuthorizationRequestResolver`ê°€ `ClientRegistration`ì„ ì½ê³ 
* â†’ `OAuth2AuthorizationRequest`(state/nonce í¬í•¨) ìƒì„± + ì„¸ì…˜ ì €ì¥
* â†’ 302 Redirectë¡œ `/oauth2/authorize?...` ì „ì†¡


