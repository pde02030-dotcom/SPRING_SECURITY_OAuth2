# ğŸ” `OAuth2LoginConfigurer<B extends HttpSecurityBuilder<B>>`

---

# ğŸ”· 1. ê°œìš” (Overview)

```java
public final class OAuth2LoginConfigurer<B extends HttpSecurityBuilder<B>>
    extends AbstractAuthenticationFilterConfigurer<
        B,
        OAuth2LoginConfigurer<B>,
        OAuth2LoginAuthenticationFilter>
```

## âœ… ì—­í• 

`OAuth2LoginConfigurer`ëŠ” **OAuth 2.0 / OpenID Connect 1.0 ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ êµ¬ì„±í•˜ëŠ” DSL êµ¬ì„±ì(Configurer)** ì…ë‹ˆë‹¤.

ì¦‰,

```java
http.oauth2Login();
```

ì´ í˜¸ì¶œë˜ë©´ ë‚´ë¶€ì ìœ¼ë¡œ:

* `OAuth2LoginConfigurer` ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ê³ 
* OAuth2 ë¡œê·¸ì¸ì— í•„ìš”í•œ í•„í„°/Provider/ê³µìœ  ê°ì²´ê°€
* `SecurityFilterChain`ì— ìë™ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤. âš™ï¸

ğŸ‘‰ **OAuth2 ë¡œê·¸ì¸ íë¦„ ì „ì²´ë¥¼ ì¡°ë¦½í•˜ëŠ” DSL ì—”ì§„**ì´ë¼ê³  ë³´ë©´ ë©ë‹ˆë‹¤.

---

# ğŸ”· 2. ì„¤ê³„ ê³„ì¸µ êµ¬ì¡° (Inheritance Hierarchy)

```
AbstractHttpConfigurer
   â””â”€ AbstractAuthenticationFilterConfigurer
         â””â”€ OAuth2LoginConfigurer
```

## ê° ê³„ì¸µì˜ ì˜ë¯¸

### ğŸ”¹ `AbstractHttpConfigurer`

* `HttpSecurity` DSL í™•ì¥ì„ ìœ„í•œ ê¸°ë³¸ í´ë˜ìŠ¤
* `init()` / `configure()` ìƒëª…ì£¼ê¸° ì œê³µ

### ğŸ”¹ `AbstractAuthenticationFilterConfigurer`

* â€œì¸ì¦ í•„í„° ê¸°ë°˜ ë¡œê·¸ì¸ íë¦„â€ì„ êµ¬ì„±í•˜ëŠ” ì¶”ìƒ í´ë˜ìŠ¤
* ë¡œê·¸ì¸ í˜ì´ì§€, ì„±ê³µ/ì‹¤íŒ¨ í•¸ë“¤ëŸ¬, í•„í„° ë“±ë¡ ë¡œì§ ì œê³µ

### ğŸ”¹ `OAuth2LoginConfigurer`

* OAuth2/OIDC ë¡œê·¸ì¸ì— í•„ìš”í•œ:

  * ë¦¬ë””ë ‰ì…˜ í•„í„°
  * ì½œë°± í•„í„°
  * Provider
  * UserService
  * í† í° ì €ì¥ì†Œ
    ë“±ì„ ì‹¤ì œë¡œ ì—°ê²°í•˜ëŠ” êµ¬í˜„ì²´

---

# ğŸ”· 3. ì§€ì› ê¸°ëŠ¥ (OAuth 2.0 / OIDC ê¸°ë°˜ ë¡œê·¸ì¸)

> OAuth 2.0 Login provides an application with the capability to have users log in by using their existing account at an OAuth 2.0 or OpenID Connect 1.0 Provider.

## âœ… ê¸°ëŠ¥ ìš”ì•½

* Google, Kakao, Naver, GitHub ë“± OAuth2 Provider ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ê°€ëŠ¥
* ì§€ì› í”Œë¡œìš°: **Authorization Code Grant ONLY** ğŸ”
* OIDC(`openid` scope)ì¼ ê²½ìš°:

  * `id_token`
  * `JWK ê²€ì¦`
  * `OidcUserService`
    ê¹Œì§€ ìë™ ì—°ê²°ë¨ ğŸªª

---

# ğŸ”· 4. ë“±ë¡ë˜ëŠ” Security Filter

`oauth2Login()`ì„ í˜¸ì¶œí•˜ë©´ ì•„ë˜ ë‘ í•„í„°ê°€ ìë™ ë“±ë¡ë©ë‹ˆë‹¤.

| í•„í„°                                         | ì—­í•                                                                              |
| ------------------------------------------ | ------------------------------------------------------------------------------ |
| `OAuth2AuthorizationRequestRedirectFilter` | `/oauth2/authorization/{registrationId}` ìš”ì²­ì„ ê°€ë¡œì±„ Authorization Serverë¡œ ë¦¬ë””ë ‰ì…˜ ğŸš€ |
| `OAuth2LoginAuthenticationFilter`          | `/login/oauth2/code/{registrationId}` ì½œë°± ìš”ì²­ ì²˜ë¦¬ ğŸ”                              |

## OAuth2 ì „ì²´ íë¦„

```
[1] /oauth2/authorization/google
     â†’ OAuth2AuthorizationRequestRedirectFilter

[2] (ë¡œê·¸ì¸/ë™ì˜ í›„)
     â†’ /login/oauth2/code/google?code=...

     â†’ OAuth2LoginAuthenticationFilter
```

---

# ğŸ”· 5. ê³µìœ  ê°ì²´ (Shared Objects Created)

`OAuth2LoginConfigurer`ëŠ” ë‹¤ìŒ Shared Objectë“¤ì„ ìƒì„±/ì‚¬ìš©í•©ë‹ˆë‹¤.

## ğŸ“Œ ìƒì„±ë˜ëŠ” ê³µìœ  ê°ì²´

| ê°ì²´                                 | í•„ìˆ˜ ì—¬ë¶€ | ì„¤ëª…                   |
| ---------------------------------- | ----- | -------------------- |
| `ClientRegistrationRepository`     | âœ… í•„ìˆ˜  | OAuth2 ê³µê¸‰ì ë©”íƒ€ë°ì´í„° ì €ì¥ì†Œ |
| `OAuth2AuthorizedClientRepository` | ì„ íƒ    | ì‚¬ìš©ì-ê³µê¸‰ì í† í° ì €ì¥ì†Œ       |
| `GrantedAuthoritiesMapper`         | ì„ íƒ    | scope â†’ ROLE ë§¤í•‘ ì „ëµ   |

---

## ğŸ“Œ ê° ê°ì²´ì˜ ì—­í• 

### ğŸ”¹ 1ï¸âƒ£ ClientRegistrationRepository (í•„ìˆ˜)

* Google, Kakao ë“± Provider ì •ë³´ ì €ì¥
* authorizationUri / tokenUri / userInfoUri ë“± í¬í•¨
* ë°˜ë“œì‹œ ì¡´ì¬í•´ì•¼ í•¨ â—

ì—†ìœ¼ë©´:

```
IllegalStateException:
ClientRegistrationRepository must be set
```

---

### ğŸ”¹ 2ï¸âƒ£ OAuth2AuthorizedClientRepository

* ì‚¬ìš©ìë³„ Access Token / Refresh Token ì €ì¥
* ê¸°ë³¸ êµ¬í˜„:

  * `HttpSessionOAuth2AuthorizedClientRepository`

ì €ì¥ ìœ„ì¹˜:

* Session
* Cookie
* DB (ì»¤ìŠ¤í…€ ê°€ëŠ¥)

---

### ğŸ”¹ 3ï¸âƒ£ GrantedAuthoritiesMapper

* Providerì—ì„œ ë°›ì€ scopeë¥¼
* Spring Securityì˜ `ROLE_` ê¶Œí•œìœ¼ë¡œ ë³€í™˜

ì˜ˆ:

```
SCOPE_profile â†’ ROLE_USER
```

---

# ğŸ”· 6. Shared Objects Used (ë‚´ë¶€ì—ì„œ ì‚¬ìš©ë˜ëŠ” ê°ì²´)

| ê°ì²´                               | ì‚¬ìš© ëª©ì                  |
| -------------------------------- | --------------------- |
| ClientRegistrationRepository     | ë¦¬ë””ë ‰ì…˜ URL ìƒì„±, Token ìš”ì²­ |
| OAuth2AuthorizedClientRepository | í† í° ì €ì¥                 |
| GrantedAuthoritiesMapper         | scope â†’ ê¶Œí•œ ë§¤í•‘         |
| DefaultLoginPageGeneratingFilter | ë””í´íŠ¸ ë¡œê·¸ì¸ UI ìƒì„±         |

---

# ğŸ”· 7. ìë™ ë¡œê·¸ì¸ í˜ì´ì§€ ìƒì„±

ì¡°ê±´:

```
loginPage()ë¥¼ ì„¤ì •í•˜ì§€ ì•Šê³ 
DefaultLoginPageGeneratingFilterê°€ ì¡´ì¬í•˜ë©´
```

â†’ `/login` ê²½ë¡œì— ìë™ ë¡œê·¸ì¸ UI ìƒì„± ğŸ–¥ï¸

ìë™ ìƒì„± ë‚´ìš©:

* ê° providerë³„ ë¡œê·¸ì¸ ë²„íŠ¼ ë§í¬
* `/oauth2/authorization/{registrationId}` ìë™ ì—°ê²°

---

# ğŸ”· 8. êµ¬ì„± íë¦„ (Lifecycle)

```java
http
  .oauth2Login()
    .loginPage("/custom-login")
    .authorizationEndpoint()
    .tokenEndpoint()
    .userInfoEndpoint()
    .and()
  .successHandler(...)
  .failureHandler(...);
```

## ë‚´ë¶€ ë‹¨ê³„

| ë‹¨ê³„                                | ì„¤ëª…                     |
| --------------------------------- | ---------------------- |
| `init()`                          | í•„í„° ìƒì„±, SharedObject ì„¤ì • |
| `configure()`                     | í•„í„° ì²´ì¸ì— í•„í„° ì‚½ì…           |
| `.userService()`                  | ì‚¬ìš©ì ì •ë³´ ì²˜ë¦¬ ì „ëµ ì„¤ì •        |
| `.clientRegistrationRepository()` | í´ë¼ì´ì–¸íŠ¸ ì •ë³´ ì§ì ‘ ì£¼ì… ê°€ëŠ¥      |

---

# ğŸ”· 9. í•µì‹¬ ë‚´ë¶€ í•„ë“œ

`OAuth2LoginConfigurer` ë‚´ë¶€ ì£¼ìš” í•„ë“œ:

| í•„ë“œ                                         | ì„¤ëª…                   |
| ------------------------------------------ | -------------------- |
| `OAuth2AuthorizationRequestRedirectFilter` | ë¡œê·¸ì¸ ì‹œì‘ ë¦¬ë””ë ‰ì…˜ í•„í„°       |
| `OAuth2LoginAuthenticationFilter`          | ì½œë°± ì²˜ë¦¬ í•„í„°             |
| `authenticationSuccessHandler`             | ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬            |
| `authenticationFailureHandler`             | ë¡œê·¸ì¸ ì‹¤íŒ¨ ì²˜ë¦¬            |
| `userInfoEndpointConfig`                   | OAuth2UserService ì„¤ì • |

---

# ğŸ”· 10. ìµœì†Œ êµ¬ì„± ì¡°ê±´

> The only required configuration is `ClientRegistrationRepository`

ì¦‰ ë°˜ë“œì‹œ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ê°€ í•„ìš”:

```java
@Bean
public ClientRegistrationRepository clientRegistrationRepository() {
   return new InMemoryClientRegistrationRepository(...);
}
```

ë˜ëŠ”

```java
.oauth2Login()
.clientRegistrationRepository(...)
```

---

# ğŸ”· 11. ì˜ˆì‹œ ì •ë¦¬

```java
@Bean
public ClientRegistrationRepository clientRegistrationRepository() {
    return new InMemoryClientRegistrationRepository(googleRegistration());
}

@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
        .oauth2Login()
        .userInfoEndpoint()
        .userService(customOAuth2UserService);

    return http.build();
}
```

---

# ğŸ”· 12. ìµœì¢… ìš”ì•½ í‘œ

| í•­ëª©         | ì„¤ëª…                                                                                             |
| ---------- | ---------------------------------------------------------------------------------------------- |
| í´ë˜ìŠ¤        | `OAuth2LoginConfigurer<B extends HttpSecurityBuilder<B>>`                                      |
| ìƒì† ê³„ì¸µ      | `AbstractAuthenticationFilterConfigurer â†’ AbstractHttpConfigurer`                              |
| ëª©ì          | OAuth2 / OIDC ë¡œê·¸ì¸ íë¦„ êµ¬ì„±                                                                        |
| ì£¼ìš” í•„í„°      | `OAuth2AuthorizationRequestRedirectFilter`, `OAuth2LoginAuthenticationFilter`                  |
| ê³µìœ  ê°ì²´      | `ClientRegistrationRepository`, `OAuth2AuthorizedClientRepository`, `GrantedAuthoritiesMapper` |
| í•„ìˆ˜ ì„¤ì •      | `ClientRegistrationRepository`                                                                 |
| ì£¼ìš” DSL ë©”ì„œë“œ | `.userInfoEndpoint().userService(...)`, `.loginPage(...)`, `.successHandler(...)`              |
| ìë™ ë¡œê·¸ì¸ í˜ì´ì§€ | `/login` ê¸°ë³¸ ìƒì„± ê°€ëŠ¥                                                                              |

---

# ğŸ¯ í•µì‹¬ ì •ë¦¬ í•œ ë¬¸ì¥

`OAuth2LoginConfigurer`ëŠ”
**OAuth2 / OIDC Authorization Code ë¡œê·¸ì¸ íë¦„ ì „ì²´ë¥¼ ì¡°ë¦½í•˜ì—¬ SecurityFilterChainì— ì—°ê²°í•˜ëŠ” DSL êµ¬ì„± ì—”ì§„**ì…ë‹ˆë‹¤. ğŸ”âš™ï¸

