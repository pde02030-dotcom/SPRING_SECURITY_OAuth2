# Spring Security `OAuth2UserService` ğŸ§©ğŸ”

`OAuth2User`ê°€ â€œë¡œê·¸ì¸ ì„±ê³µ í›„ Principal(ì¸ì¦ ì£¼ì²´)â€ì´ë¼ë©´,
`OAuth2UserService`ëŠ” **â€œê·¸ Principalì„ ë§Œë“¤ì–´ì˜¤ëŠ” ê³µì¥(factory)â€** ì…ë‹ˆë‹¤ ğŸ­âœ¨

ì¦‰, **OAuth2 ë¡œê·¸ì¸ ê³¼ì •ì—ì„œ â€˜ì‚¬ìš©ì ì •ë³´ë¥¼ ì–´ë””ì„œ ê°€ì ¸ì˜¤ê³ , ì–´ë–»ê²Œ ê°€ê³µí•´ì„œ, ì–´ë–¤ Principalë¡œ ë§Œë“¤ì§€â€™** ë¥¼ ì±…ì„ì§€ëŠ” í•µì‹¬ í™•ì¥ ì§€ì ì´ `OAuth2UserService`ì…ë‹ˆë‹¤.

---

## 1) `OAuth2UserService`ê°€ í•˜ëŠ” ì¼ í•œ ì¤„ ìš”ì•½ ğŸ§ âœ…

âœ… **Authorization Server(êµ¬ê¸€/ê¹ƒí—ˆë¸Œ/ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ ë“±)ë¡œë¶€í„° ì‚¬ìš©ì ì •ë³´ë¥¼ ë¡œë”©í•´ì„œ `OAuth2User`(Principal)ë¡œ ë§Œë“¤ì–´ Spring Securityì—ê²Œ ëŒë ¤ì¤€ë‹¤.**

---

## 2) ì–´ë””ì„œ í˜¸ì¶œë˜ë‚˜? (ì¸ì¦ í”Œë¡œìš°ì—ì„œì˜ ìœ„ì¹˜) ğŸ”ğŸ§­

OAuth2 ë¡œê·¸ì¸ íë¦„ì—ì„œ `OAuth2UserService`ëŠ” ë³´í†µ ì´ íƒ€ì´ë°ì— í˜¸ì¶œë©ë‹ˆë‹¤.

1. ì‚¬ìš©ìê°€ Provider ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ ğŸ
2. ì¸ì¦ ì„±ê³µ â†’ `authorization code`ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ğŸ”
3. Spring Securityê°€ codeë¡œ í† í° êµí™˜ ğŸ«â¡ï¸ğŸ”‘
4. **(ì—¬ê¸°!) UserInfo Endpoint í˜¸ì¶œí•´ì„œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ğŸ“¡**
5. ì‚¬ìš©ì ì •ë³´ë¥¼ `OAuth2User`ë¡œ í¬ì¥í•´ì„œ Authentication ìƒì„± ğŸ§©
6. SecurityContextì— ì €ì¥ ğŸ§ 

ğŸ“Œ 4ë²ˆ ë‹¨ê³„ì˜ â€œUserInfo Endpoint í˜¸ì¶œ + ì‚¬ìš©ì ì •ë³´ ë§¤í•‘â€ì˜ ì£¼ì²´ê°€ ë°”ë¡œ `OAuth2UserService`ì…ë‹ˆë‹¤.

---

## 3) ì¸í„°í˜ì´ìŠ¤ ì‹œê·¸ë‹ˆì²˜ êµ¬ì¡° ğŸ§±

```java
public interface OAuth2UserService<R extends OAuth2UserRequest, U extends OAuth2User> {
    U loadUser(R userRequest) throws OAuth2AuthenticationException;
}
```

### âœ… í•µì‹¬ ì•„ê·œë¨¼íŠ¸ `OAuth2UserRequest` ì•ˆì— ë­ê°€ ìˆë‚˜? ğŸ“¦

* `ClientRegistration`

  * registrationId (google, github, naver ë“±)
  * userInfoUri / tokenUri / authorizationUri
  * userNameAttributeName (getName()ì— ì“°ëŠ” í‚¤)
  * scope
* `OAuth2AccessToken`

  * ì‹¤ì œ ì•¡ì„¸ìŠ¤ í† í°(Providerì— UserInfo ìš”ì²­í•  ë•Œ ì‚¬ìš©)

ì¦‰, `loadUser()`ëŠ”
**â€œì–´ë–¤ Providerë¡œë¶€í„°, ì–´ë–¤ í† í°ì„ ê°€ì§€ê³ , ì–´ë–¤ userNameAttribute í‚¤ë¥¼ ì“¸ì§€â€** ì •ë³´ë¥¼ ì´ë¯¸ ë‹¤ ë“¤ê³  ì‹œì‘í•©ë‹ˆë‹¤. ğŸ§ 

---

## 4) ê¸°ë³¸ êµ¬í˜„ì²´: `DefaultOAuth2UserService` ğŸ§°

Spring SecurityëŠ” ê¸°ë³¸ êµ¬í˜„ì²´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

* `DefaultOAuth2UserService`

  * UserInfo Endpointë¥¼ í˜¸ì¶œ
  * ì‘ë‹µ JSONì„ Mapìœ¼ë¡œ ë°›ì•„
  * `DefaultOAuth2User`ë¥¼ ë§Œë“¤ì–´ ë°˜í™˜

ê·¸ë˜ì„œ ì»¤ìŠ¤í…€ êµ¬í˜„í•  ë•Œë„ ë³´í†µ â€œê¸°ë³¸ ë¡œë”©ì€ delegateì—ê²Œ ë§¡ê¸°ê³ , ë‚˜ëŠ” í›„ì²˜ë¦¬ë§Œ í•œë‹¤â€ íŒ¨í„´ì„ ì”ë‹ˆë‹¤. âœ…

---

## 5) ì™œ ì»¤ìŠ¤í…€ì´ ê±°ì˜ í•„ìˆ˜ì¸ê°€? (í˜„ì—… ì²´í¬ë¦¬ìŠ¤íŠ¸) ğŸ“‹ğŸ”¥

`DefaultOAuth2UserService`ë§Œ ì“°ë©´ â€œë¡œê·¸ì¸â€ì€ ë˜ëŠ”ë°, ë³´í†µ ì•„ë˜ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.

âœ… í˜„ì—…ì—ì„œ ì¶”ê°€ë¡œ í•„ìš”í•œ ê²ƒë“¤

* ìš°ë¦¬ DBì— ì‚¬ìš©ì **ê°€ì…/ì—…ë°ì´íŠ¸(Upsert)** ğŸ§¾
* Providerë§ˆë‹¤ ë‹¤ë¥¸ JSON êµ¬ì¡°ë¥¼ **í‘œì¤€í™”(normalize)** ğŸ§¼
* ê¶Œí•œ(Role) ë¶€ì—¬ (ROLE_USER / ROLE_ADMIN ë“±) ğŸ›¡ï¸
* ì°¨ë‹¨/íƒˆí‡´/íœ´ë©´ ì‚¬ìš©ì ì²˜ë¦¬ ğŸš«
* ì´ë©”ì¼ ë¯¸ì œê³µ/ë™ì˜ ë¯¸ì™„ë£Œ ê°™ì€ ì˜ˆì™¸ ì²˜ë¦¬ âš ï¸
* ë©€í‹° Provider ê³„ì • ì—°ê²°(google+github ë§í¬) ğŸ”—

ì´ê±¸ í•˜ëŠ” ìë¦¬ê°€ ëŒ€ë¶€ë¶„ `OAuth2UserService`ì…ë‹ˆë‹¤.

---

## 6) ì»¤ìŠ¤í…€ `OAuth2UserService`ì˜ â€œì •ì„ íŒ¨í„´â€ ğŸ—ï¸âœ¨

### âœ… íŒ¨í„´: Delegate + í›„ì²˜ë¦¬(í‘œì¤€í™”/DB/ê¶Œí•œ)

```java
@Service
public class CustomOAuth2UserService
        implements OAuth2UserService<OAuth2UserRequest, OAuth2User> {

    private final DefaultOAuth2UserService delegate = new DefaultOAuth2UserService();
    private final UserRepository userRepository;

    public CustomOAuth2UserService(UserRepository userRepository) {
        this.userRepository = userRepository;
    }

    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {

        // 1) Providerì—ì„œ ì‚¬ìš©ì ì •ë³´ ë¡œë”©(ê¸°ë³¸ ë¡œì§ì€ delegateì—ê²Œ)
        OAuth2User oauth2User = delegate.loadUser(userRequest);

        // 2) ì–´ë–¤ providerì¸ì§€ ì‹ë³„
        String registrationId = userRequest.getClientRegistration().getRegistrationId();

        // 3) getName()ì— ì‚¬ìš©í•  attribute key (providerë§ˆë‹¤ ë‹¤ë¦„)
        String userNameAttrName = userRequest.getClientRegistration()
                .getProviderDetails()
                .getUserInfoEndpoint()
                .getUserNameAttributeName();

        Map<String, Object> attributes = oauth2User.getAttributes();

        // 4) Providerë³„ attributes â†’ ìš°ë¦¬ ì„œë¹„ìŠ¤ í‘œì¤€ í˜•íƒœë¡œ ë³€í™˜
        OAuthAttributes mapped = OAuthAttributes.of(registrationId, userNameAttrName, attributes);

        // 5) DB ì €ì¥/ì—…ë°ì´íŠ¸ (Upsert)
        User user = saveOrUpdate(mapped);

        // 6) ê¶Œí•œ ë¶€ì—¬ (ì˜ˆ: DB ê¸°ë°˜ ê¶Œí•œ)
        Collection<GrantedAuthority> authorities = List.of(
                new SimpleGrantedAuthority("ROLE_USER")
        );

        // 7) ìµœì¢… Principal ë°˜í™˜
        return new DefaultOAuth2User(authorities, attributes, userNameAttrName);
    }

    private User saveOrUpdate(OAuthAttributes mapped) {
        return userRepository.findByProviderAndProviderId(mapped.provider(), mapped.providerId())
                .map(u -> u.updateProfile(mapped.email(), mapped.name(), mapped.picture()))
                .orElseGet(() -> userRepository.save(mapped.toEntity()));
    }
}
```

ğŸ“Œ í¬ì¸íŠ¸

* `delegate.loadUser()`ê°€ UserInfo í˜¸ì¶œì„ ë‹´ë‹¹
* ìš°ë¦¬ëŠ” attributesë¥¼ â€œí‘œì¤€í™” + DB ì²˜ë¦¬ + ê¶Œí•œ ë¶€ì—¬â€ë§Œ í•œë‹¤
* ë§ˆì§€ë§‰ì— ë°˜í™˜í•˜ëŠ” `OAuth2User`ê°€ **ìµœì¢… Principal**ì´ ëœë‹¤ ğŸ§©

---

## 7) Providerë³„ í‘œì¤€í™” í´ë˜ìŠ¤(`OAuthAttributes`) ì„¤ê³„ ğŸ§¼ğŸ“¦

í˜„ì—…ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ì´ ì—¬ê¸°ì…ë‹ˆë‹¤.
Providerë³„ ì‘ë‹µ í˜•íƒœê°€ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— â€œí‘œì¤€ DTOâ€ë¡œ í•œë²ˆ í†µì¼í•´ì•¼ ì„œë¹„ìŠ¤ ì½”ë“œê°€ ê¹¨ë—í•´ì§‘ë‹ˆë‹¤.

### âœ… ì˜ˆì‹œ: í†µí•© ë§¤í¼(ê°„ë‹¨ ë²„ì „)

```java
public record OAuthAttributes(
        String provider,
        String providerId,
        String email,
        String name,
        String picture
) {
    public static OAuthAttributes of(String registrationId, String userNameAttrName, Map<String, Object> attrs) {
        return switch (registrationId) {
            case "google" -> ofGoogle(attrs);
            case "github" -> ofGithub(attrs);
            // case "naver" -> ofNaver(attrs);  // response ì¤‘ì²©
            // case "kakao" -> ofKakao(attrs);  // kakao_account ì¤‘ì²©
            default -> throw new IllegalArgumentException("Unsupported provider: " + registrationId);
        };
    }

    private static OAuthAttributes ofGoogle(Map<String, Object> a) {
        return new OAuthAttributes(
                "google",
                (String) a.get("sub"),
                (String) a.get("email"),
                (String) a.get("name"),
                (String) a.get("picture")
        );
    }

    private static OAuthAttributes ofGithub(Map<String, Object> a) {
        // githubëŠ” idê°€ ìˆ«ì(Long/Integer)ì¼ ìˆ˜ ìˆì–´ String ë³€í™˜ ê¶Œì¥
        return new OAuthAttributes(
                "github",
                String.valueOf(a.get("id")),
                (String) a.get("email"),   // ê³µê°œ/ë™ì˜ ì—¬ë¶€ì— ë”°ë¼ null ê°€ëŠ¥
                (String) a.get("login"),
                (String) a.get("avatar_url")
        );
    }

    public User toEntity() {
        return new User(provider, providerId, email, name, picture);
    }
}
```

âš ï¸ ì£¼ì˜

* ê¹ƒí—ˆë¸Œ emailì€ nullì´ í”í•©ë‹ˆë‹¤(ë¹„ê³µê°œ ì„¤ì •) â†’ ì˜ˆì™¸ ì²˜ë¦¬ í•„ìš” ğŸ§¨
* ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ëŠ” ì¤‘ì²© Map íŒŒì‹±ì´ í•„ìš”í•©ë‹ˆë‹¤.

---

## 8) Security ì„¤ì •ì— ì—°ê²°í•˜ê¸° ğŸ”§

Spring Security ì„¤ì •ì—ì„œ `oauth2Login().userInfoEndpoint().userService(...)`ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.

```java
@Bean
SecurityFilterChain filterChain(HttpSecurity http, CustomOAuth2UserService custom) throws Exception {
    http
        .authorizeHttpRequests(auth -> auth
            .requestMatchers("/", "/login**").permitAll()
            .anyRequest().authenticated()
        )
        .oauth2Login(oauth -> oauth
            .userInfoEndpoint(userInfo -> userInfo
                .userService(custom)
            )
        );

    return http.build();
}
```

---

## 9) `OAuth2UserService`ì—ì„œ ë§ì´ í•˜ëŠ” â€œì¶”ê°€ ì •ì±…ë“¤â€ ğŸ§·ğŸ›¡ï¸

### âœ… (1) ì´ë©”ì¼ì´ ì—†ìœ¼ë©´ ê°€ì… ë§‰ê¸° ğŸ“­ğŸš«

* githubì²˜ëŸ¼ emailì´ nullì¼ ìˆ˜ ìˆìŒ
* â€œì´ë©”ì¼ ì—†ìœ¼ë©´ ì¶”ê°€ ë™ì˜ í˜ì´ì§€ë¡œ ë³´ë‚´ê¸°â€ ê°™ì€ ì „ëµ í•„ìš”

### âœ… (2) ë„ë©”ì¸ ì œí•œ(íšŒì‚¬ ì´ë©”ì¼ë§Œ í—ˆìš©) ğŸ¢

* `@company.com`ë§Œ ê°€ì… í—ˆìš©
* ì•„ë‹ˆë©´ ì ‘ê·¼ ì°¨ë‹¨

### âœ… (3) Role ë¶€ì—¬ ì •ì±… ğŸ›¡ï¸

* ìµœì´ˆ ê°€ì…ì€ ROLE_USER
* íŠ¹ì • ì¡°ê±´(ê´€ë¦¬ì ì´ë©”ì¼ ë¦¬ìŠ¤íŠ¸ / DB flag)ì´ë©´ ROLE_ADMIN

### âœ… (4) ê³„ì • ìƒíƒœ ì²´í¬ ğŸš¦

* íƒˆí‡´/ì°¨ë‹¨/íœ´ë©´ì´ë©´ ë¡œê·¸ì¸ ë§‰ê¸°
* ì‚¬ìœ  ë©”ì‹œì§€/ë¡œê·¸ì¸ ì‹¤íŒ¨ í•¸ë“¤ë§

---

## 10) ìì£¼ í„°ì§€ëŠ” ì—ëŸ¬/í•¨ì • TOP 7 âš ï¸ğŸ’¥

1. `user-name-attribute` ì„¤ì • ëˆ„ë½
   â†’ Providerê°€ ìš”êµ¬í•˜ëŠ” í‚¤ë¥¼ ëª» ì°¾ì•„ì„œ `getName()`ì´ ì´ìƒí•´ì§

2. Providerë³„ë¡œ attribute êµ¬ì¡°ê°€ ë‹¤ë¥¸ë° ë‹¨ì¼ í‚¤ë¡œ íŒŒì‹±
   â†’ ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ì—ì„œ ê¹¨ì§

3. Github email nullì„ ê³ ë ¤ ì•ˆ í•¨
   â†’ NPE / ê°€ì… ë¡œì§ ì‹¤íŒ¨

4. `loadUser()`ì—ì„œ DB íŠ¸ëœì­ì…˜ ë¬¸ì œ
   â†’ í•„ìš”í•˜ë©´ `@Transactional` ì ìš© ê³ ë ¤

5. `authorities`ê°€ ë¹„ì–´ ìˆìŒ
   â†’ ë¡œê·¸ì¸ì€ ë˜ëŠ”ë° ì ‘ê·¼ ì œì–´ê°€ ë‹¤ ë§‰íˆê±°ë‚˜, ë°˜ëŒ€ë¡œ ë‹¤ ì—´ë¦¬ê±°ë‚˜

6. ëŒ€ìš©ëŸ‰ ì²˜ë¦¬/ì™¸ë¶€ í˜¸ì¶œ ì§€ì—°
   â†’ UserInfo í˜¸ì¶œì´ ëŠë¦¬ë©´ ë¡œê·¸ì¸ ìì²´ê°€ ëŠë ¤ì§(ìºì‹œ/ì •ì±… ê³ ë¯¼)

7. â€œí‘œì¤€ Principalâ€ì„ ì•ˆ ë§Œë“¤ê³  ì„œë¹„ìŠ¤ ì½”ë“œê°€ attributesì— ì¢…ì†ë¨
   â†’ Provider ì¶”ê°€ ìˆœê°„ ìœ ì§€ë³´ìˆ˜ í­ë°œ ğŸ’£

---

## 11) ê²°ë¡  âœï¸âœ…

`OAuth2UserService`ëŠ” OAuth2 ë¡œê·¸ì¸ì—ì„œ

* ğŸ“¡ Provider ì‚¬ìš©ì ì •ë³´ ë¡œë”©
* ğŸ§¼ Providerë³„ ì‘ë‹µ í‘œì¤€í™”
* ğŸ§¾ DB Upsert(ê°€ì…/ì—…ë°ì´íŠ¸)
* ğŸ›¡ï¸ ê¶Œí•œ ë¶€ì—¬ / ê³„ì • ì •ì±… ë°˜ì˜
* ğŸ§© ìµœì¢… Principal(`OAuth2User`) ìƒì„±

ê¹Œì§€ ë‹´ë‹¹í•˜ëŠ” **í•µì‹¬ ì»¤ìŠ¤í„°ë§ˆì´ì§• í¬ì¸íŠ¸**ì…ë‹ˆë‹¤.

