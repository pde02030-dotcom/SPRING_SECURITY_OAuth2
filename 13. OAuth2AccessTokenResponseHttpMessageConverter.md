# `OAuth2AccessTokenResponseHttpMessageConverter` ì½”ë“œ ë ˆë²¨ ë¶„ì„ ğŸ”ğŸ

(= â€œToken Endpointì˜ JSON ì‘ë‹µì„ `OAuth2AccessTokenResponse` ê°ì²´ë¡œ ë°”ê¿”ì£¼ëŠ” **í•µì‹¬ MessageConverter**â€)

`DefaultAuthorizationCodeTokenResponseClient`ê°€ Token Endpointë¡œ ìš”ì²­ì„ ë³´ë‚´ë©´, ì„œë²„ëŠ” ë³´í†µ ì´ëŸ° JSONì„ ëŒë ¤ì¤ë‹ˆë‹¤. ğŸ‘‡

```json
{
  "access_token": "xxx",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "yyy",
  "scope": "openid profile email",
  "id_token": "zzz"
}
```

ê·¸ëŸ°ë° Spring SecurityëŠ” ì´ ì‘ë‹µì„ ë‹¨ìˆœ Mapìœ¼ë¡œ ë‘ì§€ ì•Šê³ , **í‘œì¤€ ê°ì²´**ë¡œ ë°”ê¿”ì•¼ í•©ë‹ˆë‹¤.

âœ… `OAuth2AccessTokenResponse`
(= access token/refresh token/expiry/scope/additionalParameters ë“±ì„ ê°€ì§„ ì‘ë‹µ ëª¨ë¸)

ì´ ë³€í™˜ì„ â€œHTTP ì‘ë‹µ ì½ê¸°â€ ë‹¨ê³„ì—ì„œ ë‹´ë‹¹í•˜ëŠ” ê²Œ ë°”ë¡œ:

> `OAuth2AccessTokenResponseHttpMessageConverter`

ì…ë‹ˆë‹¤. ğŸ§©âœ¨

---

## 1) ì´ í´ë˜ìŠ¤ëŠ” ì–´ë””ì—ì„œ ì“°ì´ë‚˜ìš”? ğŸ§­

íë¦„ì—ì„œ ì •í™•íˆ ì´ ë¶€ë¶„ì…ë‹ˆë‹¤:

```text
DefaultAuthorizationCodeTokenResponseClient.getTokenResponse(...)
  â”œâ”€ RequestEntity ìƒì„± (form-urlencoded)
  â”œâ”€ RestTemplate.exchange(...)  ğŸŒ
  â”‚    â””â”€ (ì‘ë‹µ ë°”ë”” ì½ê¸°)
  â”‚         â†’ OAuth2AccessTokenResponseHttpMessageConverter.read(...)  â­
  â””â”€ OAuth2AccessTokenResponse ë°˜í™˜ ğŸ
```

ì¦‰, ì´ ConverterëŠ”:

âœ… Token Endpointì˜ HTTP ì‘ë‹µ ë³¸ë¬¸ì„ ì½ì–´ì„œ
âœ… `OAuth2AccessTokenResponse`ë¡œ ë°”ê¾¸ëŠ” â€œí‘œì¤€ íŒŒì„œâ€ì…ë‹ˆë‹¤.

---

## 2) MessageConverter ê´€ì ì—ì„œì˜ ì—­í•  ğŸ§ 

Springì˜ `HttpMessageConverter<T>`ëŠ” ë³´í†µ:

* `canRead(...)`: ì´ íƒ€ì…ì„ ì½ì„ ìˆ˜ ìˆë‚˜?
* `read(...)`: ë°”ë””ë¥¼ ì½ì–´ ê°ì²´ë¡œ ë³€í™˜
* `canWrite(...) / write(...)`: ê°ì²´ë¥¼ ë°”ë””ë¡œ ì“°ê¸°

ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤.

`OAuth2AccessTokenResponseHttpMessageConverter`ëŠ” **ì½ê¸°(read)** ê°€ í•µì‹¬ì´ê³ ,
(ì£¼ë¡œ token endpoint ì‘ë‹µì„ íŒŒì‹±í•˜ë¯€ë¡œ) **writeëŠ” ê±°ì˜ ì¤‘ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**

---

## 3) ë‚´ë¶€ ë™ì‘ í•µì‹¬: â€œì‘ë‹µ JSON â†’ í‘œì¤€ TokenResponseâ€ ë³€í™˜ ì•Œê³ ë¦¬ì¦˜ ğŸ”ğŸ§ 

### âœ… 1ë‹¨ê³„) JSONì„ Mapìœ¼ë¡œ ì½ê¸°

ëŒ€ë¶€ë¶„ ë‚´ë¶€ì ìœ¼ë¡œ `MappingJackson2HttpMessageConverter` ê°™ì€ Jackson ê¸°ë°˜ JSON íŒŒì„œë¥¼ ì‚¬ìš©í•´:

* `Map<String, Object>` í˜•íƒœë¡œ ë¨¼ì € ì½ìŠµë‹ˆë‹¤.

### âœ… 2ë‹¨ê³„) Mapì„ OAuth2AccessTokenResponseë¡œ ë³€í™˜

ê·¸ ë‹¤ìŒ ë³€í™˜ê¸°ëŠ” ë³´í†µ ì•„ë˜ ê·œì¹™ì„ ë”°ë¦…ë‹ˆë‹¤.

---

### âœ… ë³€í™˜ ì˜ì‚¬ì½”ë“œ(ì‹¤ì œ íë¦„ì„ ê·¸ëŒ€ë¡œ ì¬êµ¬ì„±) ğŸ§ 

```java
OAuth2AccessTokenResponse readInternal(Class<?> clazz, HttpInputMessage inputMessage) {

  Map<String, Object> tokenResponseParameters = jsonMessageConverter.read(...);

  // 1) access_token í•„ìˆ˜
  String accessToken = (String) tokenResponseParameters.get("access_token");
  if (!hasText(accessToken)) throw invalidTokenResponse("missing_access_token");

  // 2) token_type (ëŒ€ë¶€ë¶„ Bearer)
  String tokenTypeValue = (String) tokenResponseParameters.get("token_type");
  OAuth2AccessToken.TokenType tokenType = resolveTokenType(tokenTypeValue); // "Bearer" -> BEARER

  // 3) expires_in (ì´ˆ)
  long expiresIn = parseLong(tokenResponseParameters.get("expires_in")); // optional
  Instant issuedAt = Instant.now();
  Instant expiresAt = issuedAt.plusSeconds(expiresIn);

  // 4) scope íŒŒì‹±
  Set<String> scopes = parseScopes(tokenResponseParameters.get("scope"));
  // "openid profile email" -> {"openid","profile","email"}

  // 5) refresh_token (optional)
  String refreshToken = (String) tokenResponseParameters.get("refresh_token");

  // 6) additionalParameters
  // í‘œì¤€ í‚¤ë“¤(access_token, token_type, expires_in, scope, refresh_token)ì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€
  Map<String,Object> additional = extractAdditionalParameters(tokenResponseParameters);

  // 7) OAuth2AccessTokenResponse ë¹Œë“œ
  return OAuth2AccessTokenResponse.withToken(accessToken)
      .tokenType(tokenType)
      .scopes(scopes)
      .expiresIn(expiresIn)
      .refreshToken(refreshToken)
      .additionalParameters(additional)
      .build();
}
```

---

## 4) â€œadditionalParametersâ€ê°€ ì§„ì§œ ì¤‘ìš”í•©ë‹ˆë‹¤ â­

OIDC ë¡œê·¸ì¸ì—ì„œ `id_token`ì€ ë³´í†µ ì´ ì¶”ê°€ íŒŒë¼ë¯¸í„°ë¡œ ë“¤ì–´ì˜µë‹ˆë‹¤.

ì¦‰:

* `additionalParameters["id_token"] = "JWT..."`

ê·¸ë¦¬ê³  ì´í›„ `OAuth2LoginAuthenticationProvider`ê°€ ì´ ê°’ì„ êº¼ë‚´ì„œ:

* `OidcIdToken`ìœ¼ë¡œ íŒŒì‹±/ê²€ì¦
* `OidcUserRequest` êµ¬ì„±

ì„ í•©ë‹ˆë‹¤. ğŸªªâœ…

ğŸ“Œ ê²°ë¡ 
`OAuth2AccessTokenResponseHttpMessageConverter`ê°€ `id_token`ì„ â€œìœ ì‹¤ ì—†ì´â€ additionalì— ë„£ì–´ì¤˜ì•¼
OIDC íë¦„ì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.

---

## 5) ìŠ¤ì½”í”„(scope) íŒŒì‹± ë°©ì‹ ğŸ¯

Token endpointëŠ” scopeë¥¼ ë³´í†µ ë¬¸ìì—´ë¡œ ì¤ë‹ˆë‹¤.

* `"scope": "profile email openid"`

ConverterëŠ” ì´ê±¸:

* ê³µë°± ê¸°ì¤€ split â†’ Set<String>

ìœ¼ë¡œ ë°”ê¿‰ë‹ˆë‹¤.

ğŸ“Œ Providerê°€ `,`ë¡œ ì£¼ê±°ë‚˜ JSON ë°°ì—´ë¡œ ì£¼ë©´?
â¡ï¸ í‘œì¤€ì´ ì•„ë‹ˆì–´ì„œ ì»¤ìŠ¤í…€ íŒŒì„œê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ”§

---

## 6) Providerê°€ ì‘ë‹µì„ â€œì¡°ê¸ˆë§Œâ€ ë¹„í‘œì¤€ìœ¼ë¡œ ì¤˜ë„ ê¹¨ì§€ëŠ” ì§€ì  ğŸ’¥

ì‹¤ë¬´ì—ì„œ ì¢…ì¢… ë§Œë‚˜ëŠ” í† í° ì‘ë‹µ ë¹„í‘œì¤€ ì¼€ì´ìŠ¤:

### âŒ 1) access token í‚¤ ì´ë¦„ì´ ë‹¤ë¦„

* `"accessToken"` ê°™ì€ ì‹ìœ¼ë¡œ ì£¼ë©´ ê¸°ë³¸ ë³€í™˜ì€ ì‹¤íŒ¨

### âŒ 2) token_typeì´ ëˆ„ë½ë˜ê±°ë‚˜ ì´ìƒí•¨

* Bearerê°€ ì•„ë‹Œ ê°’, ë˜ëŠ” ëŒ€ì†Œë¬¸ì/í˜•ì‹ì´ ì´ìƒ

### âŒ 3) expires_inì´ ë¬¸ìì—´/ì†Œìˆ˜/ë‹¤ë¥¸ íƒ€ì…

* `"3600"` ë¬¸ìì—´ì€ ë³´í†µ íŒŒì‹± ê°€ëŠ¥í•˜ì§€ë§Œ, ì´ìƒí•œ íƒ€ì…ì´ë©´ ì‹¤íŒ¨

### âŒ 4) scopeê°€ ë°°ì—´ë¡œ ì˜´

```json
"scope": ["openid","profile"]
```

* ê¸°ë³¸ íŒŒì„œëŠ” ë¬¸ìì—´ì„ ê¸°ëŒ€í•˜ëŠ” ê²½ìš°ê°€ ë§ì•„ ì»¤ìŠ¤í…€ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## 7) ì–´ë””ê¹Œì§€ê°€ ì´ Converterì˜ ì±…ì„ì¸ê°€ìš”? ğŸ¤”

âœ… ì±…ì„(í•˜ëŠ” ì¼)

* HTTP ë°”ë””(JSON) íŒŒì‹±
* í‘œì¤€ í‚¤ë“¤ì„ í•´ì„í•´ `OAuth2AccessTokenResponse` ìƒì„±
* ë‚˜ë¨¸ì§€ í•„ë“œëŠ” additionalParametersë¡œ ë³´ì¡´

âŒ ì±…ì„(ì•ˆ í•˜ëŠ” ì¼)

* í† í° ìì²´ ê²€ì¦(JWT ê²€ì¦ ë“±) â†’ ë³„ë„ ì»´í¬ë„ŒíŠ¸(JwtDecoder ë“±)
* UserInfo í˜¸ì¶œ â†’ OAuth2UserService/OidcUserService
* refresh token ì¬ë°œê¸‰ ì²˜ë¦¬ â†’ ë‹¤ë¥¸ flow/client

---

## 8) ì‹¤ë¬´ ì»¤ìŠ¤í„°ë§ˆì´ì§• í¬ì¸íŠ¸ ğŸ”§ğŸ”¥

### âœ… 1) ì‘ë‹µ í¬ë§·ì´ ë¹„í‘œì¤€ì¸ Authorization Server ì—°ë™

* ì˜ˆ: ì‚¬ë‚´ ì„œë²„ê°€ `accessToken`, `expiresIn` ê°™ì€ í‚¤ë¥¼ ì“°ëŠ” ê²½ìš°
  â¡ï¸ ì´ Converterë¥¼ êµì²´í•˜ê±°ë‚˜, ë‚´ë¶€ `tokenResponseConverter`ë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•©ë‹ˆë‹¤.

### âœ… 2) `additionalParameters`ì— íŠ¹ì • í•„ë“œë¥¼ ê°•ì œë¡œ ìœ ì§€/ë³€í˜•

* `id_token` ì™¸ì—ë„ providerê°€ ì£¼ëŠ” ì»¤ìŠ¤í…€ í•„ë“œ(tenant, roles ë“±)ë¥¼ ìœ ì§€í•˜ê³  ì‹¶ì„ ë•Œ

### âœ… 3) scope íŒŒì‹± ë¡œì§ ë³€ê²½

* ê³µë°±ì´ ì•„ë‹Œ ë‹¤ë¥¸ delimiterë¥¼ ì“°ëŠ” ì„œë²„ ëŒ€ì‘

---

## 9) í•œ ì¤„ ìš”ì•½ ğŸ§¾âœ¨

`OAuth2AccessTokenResponseHttpMessageConverter`ëŠ”

âœ… Token Endpointì˜ JSON ì‘ë‹µì„ ì½ì–´
âœ… `access_token`, `token_type`, `expires_in`, `scope`, `refresh_token`ì„ í‘œì¤€ ê·œì¹™ìœ¼ë¡œ íŒŒì‹±í•˜ê³ 
âœ… ë‚˜ë¨¸ì§€ í•„ë“œ(íŠ¹íˆ OIDCì˜ `id_token`)ëŠ” `additionalParameters`ë¡œ ë³´ì¡´í•˜ì—¬
âœ… ìµœì¢… `OAuth2AccessTokenResponse`ë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” **í† í° ì‘ë‹µ íŒŒì„œ(MessageConverter)**ì…ë‹ˆë‹¤. ğŸğŸ”

