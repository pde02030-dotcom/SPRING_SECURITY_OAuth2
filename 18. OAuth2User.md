# Spring Securityì˜ `OAuth2User` ğŸ§©ğŸ”

Spring Securityì—ì„œ **OAuth 2 ë¡œê·¸ì¸(OAuth2 Login)** ì„ ì“°ë©´, â€œë¡œê·¸ì¸ ì„±ê³µ í›„ ì‚¬ìš©ì ì •ë³´ê°€ ì–´ë””ì— ë“¤ì–´ìˆì§€?â€ë¼ëŠ” ì§ˆë¬¸ì„ ê±°ì˜ ë¬´ì¡°ê±´ í•˜ê²Œ ë©ë‹ˆë‹¤.
ê·¸ ë‹µì˜ í•µì‹¬ì´ ë°”ë¡œ **`OAuth2User`** ì…ë‹ˆë‹¤. âœ…

`OAuth2User`ëŠ” **â€œOAuth2 Provider(êµ¬ê¸€/ê¹ƒí—ˆë¸Œ/ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ ë“±)ê°€ ì¤€ ì‚¬ìš©ì(ë¦¬ì†ŒìŠ¤ ì˜¤ë„ˆ) ì •ë³´ë¥¼ Spring Securityê°€ í‘œì¤€ í˜•íƒœë¡œ ë‹´ì•„ë‘” â€˜Principalâ€™(ì¸ì¦ ì£¼ì²´)â€** ë¼ê³  ì´í•´í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

---

## 1) `OAuth2User`ëŠ” ë¬´ì—‡ì¸ê°€? ğŸ‘¤ğŸŒ

### âœ… ì—­í•  ìš”ì•½

* OAuth2 ë¡œê·¸ì¸ ì„±ê³µ í›„, **Providerì˜ UserInfo Endpoint**(í˜¹ì€ OIDCë©´ ID Token/ UserInfo)ì—ì„œ ì–»ì€ ì‚¬ìš©ì ì •ë³´ë¥¼
* Spring Securityê°€ **ì¸ì¦ ê°ì²´(Authentication)** ì•ˆì— **Principal**ë¡œ ë„£ì–´ë‘ëŠ”ë°,
* ê·¸ Principal íƒ€ì…ì´ ë³´í†µ **`OAuth2User`** ì…ë‹ˆë‹¤.

ì¦‰, ë¡œê·¸ì¸ í›„ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë‹¤ìŒì²˜ëŸ¼ êº¼ë‚¼ ìˆ˜ ìˆëŠ” â€œí˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ìâ€ì˜ ì •ì²´ê°€ `OAuth2User`ì¸ ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤.

```java
@GetMapping("/me")
public Map<String, Object> me(@AuthenticationPrincipal OAuth2User user) {
    return user.getAttributes();
}
```

---

## 2) `OAuth2User`ì˜ ì¸í„°í˜ì´ìŠ¤ êµ¬ì¡° ğŸ§±

`OAuth2User`ëŠ” Spring Securityì—ì„œ ë‹¤ìŒ êµ¬ì¡°ë¥¼ ê°€ì§‘ë‹ˆë‹¤.

* `Principal`ì„ ìƒì†(ì •í™•íˆëŠ” `AuthenticatedPrincipal` ê³„ì—´)
* í•µì‹¬ ë©”ì„œë“œëŠ” 3ê°œ ì •ë„ë¡œ ì •ë¦¬ë©ë‹ˆë‹¤.

### âœ… í•µì‹¬ ë©”ì„œë“œ 3ì¢… ì„¸íŠ¸ ğŸ§°

#### 1) `getAttributes()` ğŸ“¦

* Providerê°€ ë‚´ë ¤ì¤€ **ì›ë³¸ ì‚¬ìš©ì ì •ë³´(Map)**
* ì˜ˆ: êµ¬ê¸€ì´ë©´ `sub`, `email`, `name`, `picture` ë“±
* ê¹ƒí—ˆë¸Œë©´ `id`, `login`, `avatar_url` ë“±

#### 2) `getAuthorities()` ğŸ›¡ï¸

* Spring Security ê¶Œí•œ ëª©ë¡
* OAuth2 ë¡œê·¸ì¸ì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œëŠ” `ROLE_USER` ê°™ì€ ê±¸ ë¶€ì—¬í•˜ê±°ë‚˜,
* ìŠ¤ì½”í”„(scope)ë¥¼ `SCOPE_xxx` í˜•íƒœë¡œ ë„£ê¸°ë„ í•©ë‹ˆë‹¤(ì„¤ì •/êµ¬í˜„ì— ë”°ë¼ ë‹¤ë¦„).

#### 3) `getName()` ğŸ·ï¸

* â€œì´ ì‚¬ìš©ìë¥¼ ì‹ë³„í•˜ëŠ” ì´ë¦„(ì‹ë³„ì)â€ ì—­í• 
* ì—¬ê¸°ì„œ ì¤‘ìš”í•œ í¬ì¸íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤ ğŸ‘‡

---

## 3) `getName()`ì´ ì™œ ì¤‘ìš”í•˜ë‚˜? (ì‹ë³„ì ë¬¸ì œ) ğŸ§ âš ï¸

`getName()`ì€ ë‹¨ìˆœíˆ í™”ë©´ì— í‘œì‹œí•  â€œì´ë¦„â€ì´ ì•„ë‹ˆë¼,
**Security ê´€ì ì—ì„œ â€˜Principal ì‹ë³„ìâ€™ë¡œ ì“°ì´ê¸° ì‰¬ìš´ ê°’**ì…ë‹ˆë‹¤.

í•˜ì§€ë§Œ Providerë§ˆë‹¤ â€œê³ ìœ  ì‹ë³„ìâ€ì˜ í‚¤ê°€ ë‹¤ë¦…ë‹ˆë‹¤.

* Google: `sub` (OIDCì˜ subject)
* GitHub: `id`
* Naver: `response.id` (ì¤‘ì²© êµ¬ì¡°)
* Kakao: `id` ë˜ëŠ” `kakao_account.email` ë“±

ê·¸ë˜ì„œ Spring SecurityëŠ” **ì–´ë–¤ attributeë¥¼ nameìœ¼ë¡œ ì“¸ì§€**ë¥¼ ì„¤ì •ì—ì„œ ì •í•´ë‘¡ë‹ˆë‹¤.

```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ...
            client-secret: ...
            scope: profile, email
        provider:
          google:
            user-name-attribute: sub
```

ğŸ§© ì´ ì„¤ì •ì˜ ì˜ë¯¸:

* `OAuth2User.getName()`ì„ í˜¸ì¶œí•  ë•Œ
* `attributes.get("sub")` ê°™ì€ ê°’ì„ nameìœ¼ë¡œ ì‚¼ê² ë‹¤!

---

## 4) `OAuth2User`ëŠ” ì–´ë””ì— ì €ì¥ë˜ë‚˜? ğŸ”„ğŸ§ 

OAuth2 ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë‚´ë¶€ì ìœ¼ë¡œ ì´ëŸ° íë¦„ì´ ë²Œì–´ì§‘ë‹ˆë‹¤.

### ğŸ” ì¸ì¦ íë¦„(ë§¤ìš° ì¤‘ìš”)

1. ì‚¬ìš©ìê°€ `/oauth2/authorization/google`ë¡œ ë¡œê·¸ì¸ ì‹œì‘ ğŸ
2. êµ¬ê¸€ ì¸ì¦ í›„ `redirect_uri`ë¡œ ëŒì•„ì˜´ ğŸ”
3. Spring Securityê°€ Authorization Codeë¥¼ í† í°ìœ¼ë¡œ êµí™˜ ğŸ«â¡ï¸ğŸ”‘
4. (OAuth2) UserInfo Endpoint í˜¸ì¶œí•´ì„œ ì‚¬ìš©ì ì •ë³´ íšë“ ğŸ“¡
5. ì‚¬ìš©ì ì •ë³´ë¥¼ `OAuth2User`ë¡œ ê°ì‹¸ì„œ `Authentication` ìƒì„± âœ…
6. `SecurityContext`ì— ì €ì¥ â†’ ì„¸ì…˜(or í† í° ê¸°ë°˜ì´ë©´ ê·¸ì— ë§ê²Œ) ğŸ§ 

ê²°ê³¼ì ìœ¼ë¡œ ì»¨íŠ¸ë¡¤ëŸ¬/ì„œë¹„ìŠ¤ ì–´ë””ì„œë“  Principalë¡œ ì ‘ê·¼ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.

---

## 5) `OAuth2User` vs `OidcUser` (OIDCì¼ ë•Œ) ğŸ†šğŸªª

ì—¬ê¸°ì„œ ë§ì´ í—·ê°ˆë¦¬ëŠ” ì§€ì ì´ ìˆìŠµë‹ˆë‹¤.

* OAuth2 ë¡œê·¸ì¸ì¸ë°, Providerê°€ **OpenID Connect(OIDC)** ë¥¼ ì§€ì›í•˜ê³ 
* scopeì— `openid`ê°€ í¬í•¨ë˜ë©´
* principalì´ `OAuth2User`ê°€ ì•„ë‹ˆë¼ **`OidcUser`** ë¡œ ë“¤ì–´ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### âœ… ì°¨ì´ ìš”ì•½

* `OAuth2User`: **UserInfo(Map attributes)** ì¤‘ì‹¬
* `OidcUser`: **ID Token(JWT) + (ì„ íƒ)UserInfo** ê¹Œì§€ í¬í•¨

  * `getIdToken()`, `getClaims()` ê°™ì€ OIDC ì „ìš© ì •ë³´ê°€ ìˆìŒ

ğŸ“Œ â€œêµ¬ê¸€ ë¡œê·¸ì¸â€ì€ ëŒ€ë¶€ë¶„ OIDCë¡œ ë™ì‘í•˜ëŠ” ê²½ìš°ê°€ ë§ì•„ì„œ, ì‹¤ì œë¡œëŠ” `OidcUser`ë¡œ ë“¤ì–´ì˜¤ëŠ” ì¼€ì´ìŠ¤ë„ í”í•©ë‹ˆë‹¤.

---

## 6) ê¸°ë³¸ êµ¬í˜„ì²´: `DefaultOAuth2User` ğŸ§±âœ…

ì‹¤ì œë¡œ Spring Securityê°€ ë§ì´ ì“°ëŠ” ê¸°ë³¸ êµ¬í˜„ì²´ëŠ” ë³´í†µ:

* `DefaultOAuth2User`

ì´ êµ¬í˜„ì²´ëŠ” ëŒ€ëµ ì´ë ‡ê²Œ êµ¬ì„±ë©ë‹ˆë‹¤.

* `attributes`: Map<String, Object>
* `authorities`: Collection<GrantedAuthority>
* `nameAttributeKey`: `getName()`ì— ì“¸ í‚¤

ì¦‰, `DefaultOAuth2User`ëŠ” ì‚¬ì‹¤ìƒ
**â€œ(ê¶Œí•œ + attributes + nameKey) ë¬¶ìŒâ€** ì…ë‹ˆë‹¤. ğŸ“¦

---

## 7) ì‹¤ì œ í˜„ì—…ì—ì„œì˜ ë¬¸ì œ: Providerë§ˆë‹¤ ì‘ë‹µ êµ¬ì¡°ê°€ ë‹¤ë¥´ë‹¤ ğŸ˜µâ€ğŸ’«ğŸŒ

`OAuth2User.getAttributes()`ê°€ **Map**ì´ë¼ í¸í•´ ë³´ì´ì§€ë§Œ,
Providerë³„ë¡œ êµ¬ì¡°ê°€ ì œê°ê°ì´ë¼ ë°”ë¡œ ì“°ë©´ ë¬¸ì œê°€ ìƒê¹ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´:

* Google: `{ sub, email, name, picture, ... }`
* Naver: `{ resultcode, message, response: { id, email, name } }`
* Kakao: `{ id, kakao_account: { email, profile: {...} } }`

ì¦‰, ì„œë¹„ìŠ¤ ì½”ë“œì—ì„œ Providerë¥¼ ë¶„ê¸°í•˜ê¸° ì‹œì‘í•˜ë©´â€¦
ì½”ë“œê°€ ì§€ì €ë¶„í•´ì§‘ë‹ˆë‹¤. ğŸ§»ğŸ’¥

---

## 8) í•´ê²° íŒ¨í„´: â€œë‚´ ì„œë¹„ìŠ¤ í‘œì¤€ ì‚¬ìš©ìâ€ë¡œ ë³€í™˜í•˜ê¸° ğŸ§¼âœ¨

í˜„ì—…ì—ì„œëŠ” ë³´í†µ `OAuth2User`ë¥¼ ê·¸ëŒ€ë¡œ ì“°ì§€ ì•Šê³ ,
**ë‚´ ì„œë¹„ìŠ¤ì˜ í‘œì¤€ User ê°ì²´(ë„ë©”ì¸/DTO)ë¡œ ë³€í™˜**í•©ë‹ˆë‹¤.

ì˜ˆ: `CustomOAuth2User` í˜¹ì€ `MyUserPrincipal`

### âœ… ëª©í‘œ

* Providerê°€ ë­ë“  ìƒê´€ì—†ì´
* ìš°ë¦¬ ì„œë¹„ìŠ¤ëŠ” `userId`, `email`, `name`, `roles` ê°™ì€ **ì¼ê´€ëœ í˜•íƒœ**ë¡œ ë‹¤ë£¬ë‹¤.

---

## 9) ì»¤ìŠ¤í…€ `OAuth2UserService`ë¡œ ë§¤í•‘/ê°€ì… ì²˜ë¦¬í•˜ê¸° ğŸ› ï¸ğŸ§¾

ê°€ì¥ í”í•œ í™•ì¥ í¬ì¸íŠ¸ëŠ”:

* `OAuth2UserService<OAuth2UserRequest, OAuth2User>`

ì—¬ê¸°ì„œ í•˜ëŠ” ì¼:

* (ê¸°ë³¸ ë¡œì§) ì‚¬ìš©ì ì •ë³´ ë¡œë”©
* (ì¶”ê°€ ë¡œì§) ìš°ë¦¬ DBì— ê°€ì…/ì—…ë°ì´íŠ¸
* (ì¶”ê°€ ë¡œì§) ê¶Œí•œ ë¶€ì—¬
* (ì¶”ê°€ ë¡œì§) â€œí‘œì¤€ Principalâ€ë¡œ ë³€í™˜

### ì˜ˆì‹œ ì½”ë“œ(ì „í˜•ì ì¸ í˜•íƒœ) ğŸ”¥

```java
@Service
public class CustomOAuth2UserService
    implements OAuth2UserService<OAuth2UserRequest, OAuth2User> {

  private final DefaultOAuth2UserService delegate = new DefaultOAuth2UserService();
  private final UserRepository userRepository;

  public CustomOAuth2UserService(UserRepository userRepository) {
    this.userRepository = userRepository;
  }

  @Override
  public OAuth2User loadUser(OAuth2UserRequest userRequest) {
    OAuth2User oauth2User = delegate.loadUser(userRequest);

    String registrationId =
        userRequest.getClientRegistration().getRegistrationId(); // google/github/naver...
    String userNameAttributeName =
        userRequest.getClientRegistration().getProviderDetails()
            .getUserInfoEndpoint().getUserNameAttributeName();

    Map<String, Object> attributes = oauth2User.getAttributes();

    // âœ… 1) Providerë³„ attribute íŒŒì‹± â†’ í‘œì¤€í™” (ì˜ˆ: email, providerId, name)
    OAuthAttributes mapped = OAuthAttributes.of(registrationId, userNameAttributeName, attributes);

    // âœ… 2) DB ì €ì¥/ì—…ë°ì´íŠ¸
    User user = userRepository.findByProviderAndProviderId(mapped.provider(), mapped.providerId())
        .map(u -> u.updateProfile(mapped.email(), mapped.name(), mapped.picture()))
        .orElseGet(() -> userRepository.save(mapped.toEntity()));

    // âœ… 3) ê¶Œí•œ ë¶€ì—¬
    Collection<GrantedAuthority> authorities = List.of(new SimpleGrantedAuthority("ROLE_USER"));

    // âœ… 4) ìµœì¢… Principal ìƒì„±
    return new DefaultOAuth2User(authorities, attributes, userNameAttributeName);
  }
}
```

ê·¸ë¦¬ê³  Security ì„¤ì •ì— ì—°ê²°:

```java
http
  .oauth2Login(oauth -> oauth
    .userInfoEndpoint(userInfo -> userInfo
      .userService(customOAuth2UserService)
    )
  );
```

---

## 10) `@AuthenticationPrincipal OAuth2User` ì‹¤ì „ íŒ ğŸ§©âœ…

### âœ… ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë°›ê¸°

```java
@GetMapping("/profile")
public String profile(@AuthenticationPrincipal OAuth2User user) {
  return "hello " + user.getAttribute("email");
}
```

### âœ… `getAttribute()`ë¥¼ ì„ í˜¸í•˜ëŠ” ì´ìœ 

`getAttributes()`ëŠ” Map ì „ì²´ë¼ì„œ ìºìŠ¤íŒ… ì§€ì˜¥ì´ ì—´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ˜µ
Spring SecurityëŠ” í¸ì˜ ë©”ì„œë“œë¡œ `getAttribute(String name)`ë„ ì œê³µí•©ë‹ˆë‹¤(êµ¬í˜„ì²´ì— ë”°ë¼).

---

## 11) ê¶Œí•œ(`authorities`)ì€ ì–´ë””ì„œ ì˜¤ë‚˜? ğŸ›¡ï¸

OAuth2 Loginì—ì„œëŠ” ì¼ë°˜ì ìœ¼ë¡œ:

* ê¸°ë³¸ì ìœ¼ë¡œ â€œë¡œê·¸ì¸ ì„±ê³µ ì‚¬ìš©ìâ€ì—ê²Œ ROLE_USERë¥¼ ì£¼ê±°ë‚˜
* scopeë¥¼ ê¶Œí•œì²˜ëŸ¼ `SCOPE_profile`, `SCOPE_email`ë¡œ ë„£ê±°ë‚˜
* DB ê¸°ë°˜ìœ¼ë¡œ `ROLE_ADMIN` ë“±ì„ ë¶€ì—¬í•©ë‹ˆë‹¤.

ğŸ“Œ ì¦‰, **`OAuth2User` ìì²´ê°€ ê¶Œí•œì„ ìë™ìœ¼ë¡œ í’ë¶€í•˜ê²Œ ë§Œë“¤ì–´ì£¼ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.**
ê¶Œí•œ ì„¤ê³„ëŠ” ê²°êµ­ â€œìš°ë¦¬ ì„œë¹„ìŠ¤ ì •ì±…â€ì…ë‹ˆë‹¤. ğŸ›ï¸

---

## 12) ìì£¼ ê²ªëŠ” ì‹¤ìˆ˜/í•¨ì • TOP 6 âš ï¸ğŸ§¨

1. **Providerë³„ë¡œ attribute í‚¤ê°€ ë‹¤ë¥¸ë°** `user.getAttribute("email")`ì„ ê³ ì •ìœ¼ë¡œ ì”€
   â†’ ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ì—ì„œ ê¹¨ì§ ğŸ’¥

2. `getName()`ì„ í™”ë©´ì— í‘œì‹œí•  ì´ë¦„ìœ¼ë¡œ ì°©ê°
   â†’ ì‚¬ì‹¤ìƒ â€œì‹ë³„ìâ€ë¡œ ì“°ì´ê¸° ì‰¬ì›€ ğŸ§ 

3. ë¡œê·¸ì¸ì€ ë˜ëŠ”ë° DBì— ì‚¬ìš©ì ì €ì¥/ê°±ì‹ ì´ ì—†ë‹¤
   â†’ ì»¤ìŠ¤í…€ `OAuth2UserService`ì—ì„œ ì²˜ë¦¬í•´ì•¼ í•¨ ğŸ§¾

4. OIDCì¸ë° `OAuth2User`ë¡œë§Œ ì²˜ë¦¬í•˜ë ¤ë‹¤ íƒ€ì… ìºìŠ¤íŒ… ë¬¸ì œ ë°œìƒ
   â†’ `OidcUser` ê³ ë ¤ í•„ìš” ğŸªª

5. ê¶Œí•œì„ `authorities`ì— ì•ˆ ë„£ê³  URL ì ‘ê·¼ ì œì–´ê°€ ì•ˆ ë¨
   â†’ ROLE ë§¤í•‘/ë¶€ì—¬ í™•ì¸ ğŸ›¡ï¸

6. ì„¸ì…˜/ë¶„ì‚° í™˜ê²½ì—ì„œ Principal ì €ì¥ ì „ëµ ë¯¸ê³ ë ¤
   â†’ ì„¸ì…˜ í´ëŸ¬ìŠ¤í„°ë§ or JWT ê¸°ë°˜ ì „ëµ ê³ ë¯¼ í•„ìš” ğŸŒ

---

## 13) í•œ ì¤„ ê²°ë¡  âœï¸âœ…

`OAuth2User`ëŠ”
**â€œOAuth2 ë¡œê·¸ì¸ ì„±ê³µ í›„ Providerê°€ ì¤€ ì‚¬ìš©ì ì •ë³´ë¥¼ Spring Securityê°€ Principalë¡œ ë“¤ê³  ìˆëŠ” í‘œì¤€ ì¸í„°í˜ì´ìŠ¤â€** ì´ë©°,
í˜„ì—…ì—ì„œëŠ” ì´ë¥¼ ê·¸ëŒ€ë¡œ ì“°ê¸°ë³´ë‹¤ **í‘œì¤€í™”/DBì—°ë™/ê¶Œí•œë¶€ì—¬**ë¥¼ ìœ„í•´ `OAuth2UserService`ë¡œ í™•ì¥í•˜ëŠ” ê²ƒì´ ê±°ì˜ í•„ìˆ˜ì…ë‹ˆë‹¤. ğŸ§©ğŸ”

