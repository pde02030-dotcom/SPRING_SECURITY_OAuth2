# `OAuth2AuthorizationRequestRedirectFilter` ì½”ë“œ ë ˆë²¨ ë¶„ì„ ğŸ”ğŸš€

(= â€œ`/oauth2/authorization/{registrationId}` ìš”ì²­ì„ ë°›ì•„ **Authorization Serverë¡œ ë³´ë‚´ëŠ”** í•„í„°â€)

`OAuth2AuthorizationRequestRedirectFilter`ëŠ” OAuth2/OIDC ë¡œê·¸ì¸ì—ì„œ **ì¶œë°œì (Start ë²„íŠ¼)** ì—­í• ì„ í•©ë‹ˆë‹¤. ğŸ§©
ì‚¬ìš©ìê°€ ë³´í†µ ì´ëŸ° URLì„ ì¹˜ì£ :

* `/oauth2/authorization/google` âœ… (ê¸°ë³¸)

ê·¸ëŸ¼ ì´ í•„í„°ê°€:

1. `ClientRegistration(google)`ì„ ì°¾ê³  ğŸ“’
2. `OAuth2AuthorizationRequest`ë¥¼ ë§Œë“¤ê³  ğŸ§¾
3. `state`(CSRF ë°©ì–´) + (í•„ìš” ì‹œ) PKCE íŒŒë¼ë¯¸í„°ë¥¼ ìƒì„±í•˜ê³  ğŸ›¡ï¸ğŸ§·
4. ê·¸ ìš”ì²­ì„ ì„¸ì…˜ì— ì €ì¥í•˜ê³  ğŸ—ƒï¸
5. Authorization Serverì˜ Authorization Endpointë¡œ **302 Redirect**ë¥¼ ë‚ ë¦½ë‹ˆë‹¤. ğŸš€

---

## 1) ì–´ë””ì— ë¼ì–´ ìˆë‚˜ìš”? ì „ì²´ íë¦„ì—ì„œì˜ ìœ„ì¹˜ ğŸ§­

```text
[START]
í´ë¼ì´ì–¸íŠ¸(ë¸Œë¼ìš°ì €)
   â””â”€ GET /oauth2/authorization/google
        â†’ OAuth2AuthorizationRequestRedirectFilter  â­ (ì¸ê°€ ìš”ì²­ ìƒì„± & redirect)
            â†’ 302 Location: https://accounts.google.com/o/oauth2/v2/auth?...&state=...

(ì‚¬ìš©ìê°€ ë¡œê·¸ì¸/ë™ì˜)

Authorization Server
   â””â”€ redirect_uri ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        â†’ /login/oauth2/code/google?code=...&state=...
            â†’ OAuth2LoginAuthenticationFilter  â­ (ì½œë°± ì²˜ë¦¬)
```

âœ… ì¦‰, RedirectFilterëŠ” â€œë‚˜ê°ˆ ë•Œâ€
âœ… LoginAuthenticationFilterëŠ” â€œëŒì•„ì˜¬ ë•Œâ€ ì…ë‹ˆë‹¤.

---

## 2) ì´ í•„í„°ì˜ í•µì‹¬ ì—­í•  5ê°€ì§€ ğŸ¯

### âœ… (1) registrationIdë¥¼ í•´ì„

`/oauth2/authorization/{registrationId}`ì—ì„œ `{registrationId}`ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.

### âœ… (2) AuthorizationRequest ìƒì„±

authorization endpointë¡œ ë³´ë‚¼ **ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ë¬¶ìŒ**ì„ ë§Œë“­ë‹ˆë‹¤.

### âœ… (3) state ìƒì„±/ì €ì¥

CSRF ë°©ì–´ í•µì‹¬: `state`ë¥¼ ë§Œë“¤ê³  ì„¸ì…˜(ì €ì¥ì†Œ)ì— ì €ì¥í•©ë‹ˆë‹¤. ğŸ›¡ï¸

### âœ… (4) (ì„ íƒ) PKCE ì ìš©

public client ë˜ëŠ” ì„¤ì •ì— ë”°ë¼ `code_challenge`ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. ğŸ§·

### âœ… (5) 302 Redirect

Authorization Serverë¡œ ë³´ë‚´ë²„ë¦½ë‹ˆë‹¤. ğŸš€

---

## 3) ë‚´ë¶€ ë™ì‘(ì˜ì‚¬ì½”ë“œ): ì§„ì§œ â€œì½”ë“œ íë¦„â€ìœ¼ë¡œ ë³´ê¸° ğŸ”

```java
void doFilterInternal(HttpServletRequest req, HttpServletResponse res, FilterChain chain) {

  // 1) ìš”ì²­ì´ /oauth2/authorization/* íŒ¨í„´ì¸ì§€ ê²€ì‚¬
  if (!matchesAuthorizationRequest(req)) {
     chain.doFilter(req, res);
     return;
  }

  // 2) registrationId ì¶”ì¶œ (ì˜ˆ: google)
  String registrationId = resolveRegistrationId(req);

  // 3) ClientRegistration ì¡°íšŒ
  ClientRegistration clientRegistration =
      clientRegistrationRepository.findByRegistrationId(registrationId);

  if (clientRegistration == null) {
     throw new OAuth2AuthenticationException("client_registration_not_found");
  }

  // 4) AuthorizationRequest ìƒì„± (í•µì‹¬)
  OAuth2AuthorizationRequest authorizationRequest =
      authorizationRequestResolver.resolve(req, registrationId);

  if (authorizationRequest == null) {
     chain.doFilter(req, res);
     return;
  }

  // 5) AuthorizationRequest ì €ì¥ (state í¬í•¨ë¨)
  authorizationRequestRepository.saveAuthorizationRequest(authorizationRequest, req, res);

  // 6) authorizationRequest.getAuthorizationRequestUri() ë¡œ 302 redirect
  sendRedirect(res, authorizationRequest.getAuthorizationRequestUri());
}
```

> âœ… í•„í„° ìì²´ëŠ” â€œìš”ì²­ ìƒì„±â€ì„ ì§ì ‘ ë‹¤ í•˜ì§€ ì•Šê³ ,
> `OAuth2AuthorizationRequestResolver`ì—ê²Œ ëŒ€ë¶€ë¶„ ìœ„ì„í•©ë‹ˆë‹¤. ğŸ§ 

---

## 4) í•µì‹¬ êµ¬ì„±ìš”ì†Œ 2ê°œ ğŸ”¥

### â‘  `OAuth2AuthorizationRequestResolver` ğŸ§¾

ê¸°ë³¸ êµ¬í˜„ì€ ë³´í†µ:

* `DefaultOAuth2AuthorizationRequestResolver`

ì´ Resolverê°€ ì‹¤ì œë¡œ ì•„ë˜ë¥¼ ë§Œë“­ë‹ˆë‹¤:

* authorization_uri (providerì˜ authorize endpoint)
* client_id
* redirect_uri
* response_type=code
* scope
* **state**
* (OIDCë©´) nonce
* (PKCEë©´) code_challenge, code_challenge_method

ì¦‰ **â€œAuthorization URL ì¡°ë¦½ê¸°â€**ì…ë‹ˆë‹¤. ğŸ—ï¸

---

### â‘¡ `AuthorizationRequestRepository` ğŸ—ƒï¸

ê¸°ë³¸ì€ ëŒ€ë¶€ë¶„ **ì„¸ì…˜ ê¸°ë°˜**ì…ë‹ˆë‹¤.

* `HttpSessionOAuth2AuthorizationRequestRepository` (ëŒ€í‘œ)

ì´ ì €ì¥ì†Œê°€ í•˜ëŠ” ì¼:

* â€œë‚˜ê°ˆ ë•Œâ€ authorizationRequest ì €ì¥
* â€œëŒì•„ì˜¬ ë•Œâ€ OAuth2LoginAuthenticationFilterê°€ êº¼ë‚´ state ê²€ì¦ì— ì‚¬ìš©

ğŸ“Œ ì €ì¥í•˜ì§€ ì•Šìœ¼ë©´?

* ì½œë°±ì—ì„œ `authorization_request_not_found` í„°ì§‘ë‹ˆë‹¤ ğŸ’¥

---

## 5) ì´ í•„í„°ê°€ ë§Œë“œëŠ” â€œAuthorization Requestâ€ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ğŸ§¾âœ¨

Authorization Endpointë¡œ ë³´ë‚´ëŠ” ëŒ€í‘œ íŒŒë¼ë¯¸í„°ëŠ” ì•„ë˜ì…ë‹ˆë‹¤.

### âœ… OAuth2 ê³µí†µ

* `response_type=code`
* `client_id=...`
* `redirect_uri=...`
* `scope=...`
* `state=...` â­

### âœ… OIDC ì¶”ê°€

* `scope`ì— `openid` í¬í•¨
* `nonce=...` (ì„¤ì •/ì¡°ê±´ì— ë”°ë¼) ğŸªª

### âœ… PKCE ì¶”ê°€

* `code_challenge=...`
* `code_challenge_method=S256` ğŸ§·

---

## 6) redirect_uriëŠ” ì–´ë–»ê²Œ ê²°ì •ë˜ë‚˜ìš”? (ì§„ì§œ ì¤‘ìš”) ğŸš¨

ë³´í†µ ì„¤ì •ì—ëŠ” ì´ë ‡ê²Œ ì”ë‹ˆë‹¤:

* `{baseUrl}/login/oauth2/code/{registrationId}`

ì—¬ê¸°ì„œ `{baseUrl}`ì€ ìš”ì²­ì„ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.

ğŸ“Œ ì‹¤ë¬´ì—ì„œ ìì£¼ ê¹¨ì§€ëŠ” ì´ìœ 

* í”„ë¡ì‹œ/ë¡œë“œë°¸ëŸ°ì„œ ë’¤ì— ìˆì„ ë•Œ
* ì™¸ë¶€ URLì€ `https://service.com`ì¸ë°
* ë‚´ë¶€ë¡œ ë“¤ì–´ì˜¤ë©´ `http://localhost:8080`ì²˜ëŸ¼ ì¸ì‹

ê·¸ëŸ¬ë©´ `{baseUrl}` ê³„ì‚°ì´ í‹€ì–´ì ¸ì„œ:

* Authorization Serverì— ë“±ë¡ëœ redirect_uriì™€ ë¶ˆì¼ì¹˜
* ê²°êµ­ **í† í° êµí™˜ ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨**í•˜ê±°ë‚˜(í˜¹ì€ ë°”ë¡œ authorize ë‹¨ê³„ì—ì„œ ì°¨ë‹¨) ğŸ’¥

âœ… í•´ê²° í‚¤ì›Œë“œ(ëŒ€í‘œ)

* Forwarded í—¤ë” ì²˜ë¦¬ (`X-Forwarded-*`)
* `ForwardedHeaderFilter` ë˜ëŠ” ì„œë²„/í”„ë¡ì‹œ ì„¤ì •
* Springì˜ `server.forward-headers-strategy` ë“± í™˜ê²½ ì„¤ì •

(ì›í•˜ì‹œë©´ ì´ ë¶€ë¶„ë§Œ â€œí”„ë¡ì‹œ í™˜ê²½ ì‹¤ì „ ë””ë²„ê¹… ê°€ì´ë“œâ€ë¡œ ë”°ë¡œ ê¹Šê²Œ ì •ë¦¬í•´ë“œë¦´ê²Œìš”.) ğŸ§¯

---

## 7) stateëŠ” ì™œ ì €ì¥í•˜ë‚˜ìš”? ğŸ›¡ï¸

`state`ëŠ” OAuth2ì˜ ëŒ€í‘œì ì¸ CSRF ë°©ì–´ ì¥ì¹˜ì…ë‹ˆë‹¤.

* RedirectFilterì—ì„œ ìƒì„± + ì €ì¥
* ì½œë°±(Filter)ì—ì„œ state ë¹„êµ
* ë‹¤ë¥´ë©´ ì¸ì¦ ì‹¤íŒ¨ (`invalid_state`)

âœ… ì´ê²Œ ì—†ìœ¼ë©´ â€œë‚´ ì„¸ì…˜ì— ë‚¨ì˜ codeë¥¼ ë¼ì›Œë„£ëŠ” ê³µê²©â€ ê°™ì€ ê²Œ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤. ğŸ˜µ

---

## 8) PKCEëŠ” ì—¬ê¸°ì„œ ì–´ë–»ê²Œ ë¼ì–´ë“œë‚˜ìš”? ğŸ§·

PKCEëŠ” â€œë‚˜ê°ˆ ë•Œâ€ê°€ í•µì‹¬ì…ë‹ˆë‹¤.

* `code_verifier` ìƒì„± (ëœë¤)
* `code_challenge = BASE64URL(SHA256(code_verifier))`
* Authorization Requestì— `code_challenge`ë¥¼ ë„£ê³ 
* `code_verifier`ëŠ” ì„¸ì…˜(authorizationRequestì˜ attributes ë“±)ì— ì €ì¥
* ë‚˜ì¤‘ì— í† í° êµí™˜ ì‹œ `code_verifier`ë¥¼ ê°™ì´ ì „ì†¡

ì¦‰:

âœ… RedirectFilter ë‹¨ê³„ì—ì„œ PKCE ì‹œë™ ê±¸ê³ 
âœ… TokenResponseClient ë‹¨ê³„ì—ì„œ code_verifierë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ğŸ¯

---

## 9) ì´ í•„í„°ì—ì„œ ìì£¼ í„°ì§€ëŠ” ë¬¸ì œ TOP 6 ğŸ§¯

1. `/oauth2/authorization/{id}` ê²½ë¡œê°€ ë³´ì•ˆ ì„¤ì •ì— ë§‰í˜
2. registrationId ì˜¤íƒ€ë¡œ ClientRegistration ëª» ì°¾ìŒ
3. ì„¸ì…˜ì´ ìœ ì§€ ì•ˆ ë¼ì„œ state ì €ì¥/ë³µì›ì´ ì‹¤íŒ¨
4. SameSite ì¿ í‚¤ ì •ì±…ìœ¼ë¡œ í¬ë¡œìŠ¤ì‚¬ì´íŠ¸ ë¦¬ë‹¤ì´ë ‰íŠ¸ì—ì„œ ì„¸ì…˜ ì¿ í‚¤ ëˆ„ë½ ğŸª
5. í”„ë¡ì‹œ í™˜ê²½ì—ì„œ `{baseUrl}` ê³„ì‚°ì´ ê¹¨ì ¸ redirect_uri ë¶ˆì¼ì¹˜ ğŸš¨
6. PKCE ê´€ë ¨ ì„¤ì • ë¶ˆì¼ì¹˜ (public clientì¸ë° ì ìš© ëˆ„ë½ ë“±)

---

## 10) í•œ ì¤„ ìš”ì•½ ğŸ§¾âœ¨

`OAuth2AuthorizationRequestRedirectFilter`ëŠ”

âœ… `/oauth2/authorization/{registrationId}` ìš”ì²­ì„ ë°›ì•„
âœ… `OAuth2AuthorizationRequest`(client_id, redirect_uri, scope, **state**, (ì˜µì…˜) PKCE/nonce)ë¥¼ ë§Œë“¤ê³ 
âœ… ê·¸ ìš”ì²­ì„ ì €ì¥ì†Œ(ë³´í†µ ì„¸ì…˜)ì— ì €ì¥í•œ ë’¤
âœ… Authorization Serverì˜ Authorization Endpointë¡œ **302 Redirect**ë¥¼ ë³´ë‚´ëŠ”
OAuth2/OIDC ë¡œê·¸ì¸ â€œì¶œë°œ í•„í„°â€ì…ë‹ˆë‹¤. ğŸš€ğŸ”

